Ext.define("Belle_Common.ux.SearchWin",{extend:"Ext.window.Window",xtype:"selectionwin",canQueryCondition:false,queryDataIndex:"a",gridColumns:null,searchNotNullField:"",url:"",searchItems:null,searchColumn:4,fieldWidth:"100%",title:"窗口选择器",width:700,height:500,isAutoLoad:true,isMultiSelect:false,filters:[],otherParams:{},modal:true,layout:"border",closeAction:"destroy",autoShow:true,formAllowBlank:true,isQueryParams:true,initComponent:function(){var b=this,a=[];if(window.innerHeight&&window.innerHeight<b.height){b.height=window.innerHeight}if(window.innerWidth&&window.innerWidth<b.width){b.width=window.innerWidth}if(!Ext.isEmpty(b.searchColumn)){a.push(b.createForm())}if(Ext.isEmpty(b.gridColumns)){Belle.alert("网格未指定任何列！");return}a.push(b.createGrid());b.items=a;b.dockedItems=[{reference:"winbtnToolbar",xtype:"toolbar",dock:"top",items:[{xtype:"button",text:"查询",width:60,margin:"0 0 0 5",reference:"winsearchbtn",glyph:Belle.Icon.btnSearch,handler:function(c){b.onSearch(c)}},{text:"过滤",icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/filters/find.png",itemId:b.id+"btnFilter",reference:"winbtnFilter",xtype:"splitbutton",menu:[{text:"本页",itemId:b.id+"btnFilterLocal",reference:"winbtnFilterLocal",handler:function(c){b.onSetFilterLocal(c)}},{text:"所有",itemId:b.id+"btnServer",reference:"winbtnFilterServer",handler:function(c){b.onSetFilterServer(c)}},{text:"关闭",itemId:b.id+"btnFilterClose",reference:"winbtnFilterClose",handler:function(c){b.onFilterClose(c)}}]},{itemId:b.id+"btnSave",reference:"winbtnSave",xtype:"button",text:"确认",glyph:Belle.Icon.btnSave,handler:function(c){b.onSave(c)}},{xtype:"button",text:"取消",glyph:Belle.Icon.btnCancel,handler:function(c){c.up("window").close()}}]}];b.callParent(arguments)},initEvents:function(){var c=this,b=c.formPanel,a=b&&b.query("textfield,combo,datefield,numberfield");if(a){Ext.each(a,function(d){d.on("specialkey",function(g,f){if(g.isExpanded!=true&&f.getKey()===f.ENTER){c.onSearch(c.lookupReference("winsearchbtn")||d)}})})}},onSearch:function(d){var g=this,f=g.getParams(),b=g.gridPanel,c=g.formPanel,h=b.getStore(),j=Belle.clone(f.queryCondition);if(!g.beforeSearch()){return}delete f.queryCondition;h.getProxy().extraParams=f;d.setDisabled(true);if(!c){if(b&&b.setOtherFilters){b.setOtherFilters(j)}h.loadPage(1,{callback:function(){d.setDisabled(false)}});return}if(!c.isValid()){d.setDisabled(false);return}if(g.formAllowBlank==false){var i=c.getValues(),a=true;for(var e in i){if(!Ext.isEmpty(i[e])){a=false}}if(a){Belle.alert("至少输入一个查询条件");d.setDisabled(false);return}}if(b&&b.setOtherFilters){b.setOtherFilters(j)}h.loadPage(1,{callback:function(){d.setDisabled(false)}})},onSave:function(){var b=this,a=b.gridPanel;var c=a.getSelection();if(b.fireEvent("onBeforeReturnData",c,a,b)==false){return}b.fireEvent("onReturnData",c,a,b);b.close()},createForm:function(){var b=this;if(Ext.isEmpty(b.searchItems)){return}if(b.canQueryCondition){Ext.each(b.searchItems,function(c){if(c.canQueryCondition!=false&&(Ext.isEmpty(c.xtype)||c.xtype=="textfield")){c.xtype="bellefilter"}})}var a=new Ext.form.Panel({border:false,region:"north",bodyPadding:3,items:[{border:false,defaultType:"textfield",layout:{type:"table",columns:b.searchColumn},defaults:{labelAlign:"right",labelWidth:80,width:b.fieldWidth},itemId:"searchfields",items:b.searchItems}]});b.formPanel=a;return a},createGrid:function(){var d=this,g,e=d.getParams(),f=Belle.clone(e.queryCondition);delete e.queryCondition;if(!d.gridColumns||!d.url){return false}var a=[];Ext.each(d.gridColumns,function(h){if(Ext.isEmpty(h.dataIndex)){return true}a.push(h.dataIndex)});var b=Ext.create("Belle_Common.store.Base",{fields:a,autoLoad:false,proxy:{extraParams:e,url:d.url}});if(d.isMultiSelect){selModel=Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"})}else{selModel={mode:"MULTI"}}var c=new Ext.grid.Panel({border:false,region:"center",columns:d.gridColumns,plugins:["belleheaderfilter"],columnLines:true,selModel:selModel,store:b,bbar:{xtype:"pagingtoolbar",plugins:Ext.create("Ext.ux.ComboPageSize"),displayInfo:true,store:b},viewConfig:{enableTextSelection:true}});if(!Ext.isEmpty(f)){if(c.setOtherFilters){c.setOtherFilters(f)}}if(d.isAutoLoad){b.load()}if(c.setFilterStatus){c.setFilterStatus(false)}if(d.isMultiSelect==false){c.on("itemdblclick",function(j,i){var h=[];h.push(i);if(d.fireEvent("onBeforeReturnData",h,c,d)==false){return false}d.fireEvent("onReturnData",h,c,d);d.close()})}d.gridPanel=c;return c},onFilterClose:function(b){var c=this,a=c.gridPanel;if(typeof(a.setFilterStatus)=="function"){a.setFilterStatus(false);c._setBtnFilterText(b.up("[itemId='"+c.id+"btnFilter']"))}},onSetFilterLocal:function(b){var c=this,a=c.gridPanel;if(typeof(a.setFilterStatus)=="function"){a.setFilterLocal(true)}c._setBtnFilterText(b.up("[itemId='"+c.id+"btnFilter']"))},onSetFilterServer:function(b){var c=this,a=c.gridPanel;if(typeof(a.setFilterStatus)=="function"){a.setFilterLocal(false)}c._setBtnFilterText(b.up("[itemId='"+c.id+"btnFilter']"))},_setBtnFilterText:function(b){var c=this,a=c.gridPanel;if(typeof(a.setFilterStatus)!="function"){b.setText("请加入filter插件");return}if(a.getFilterStatus()){text="过滤["+(a.isLocal?"本页":"所有")+"]"}else{text="过滤"}b.setText(text)},getParams:function(){var e=this,d=e.formPanel,b=d?d.getValues():{},c=Belle.clone(e.otherParams)||{},h=[];if(!d||d.isValid()==false){return c}for(var f in b){var a=Belle.getField(d,f),g=b[f];if(g.join){g="'"+b[f].join("','")+"'"}if(!Ext.isEmpty(g)){if(a.xtype=="bellefilter"){h.push({property:a.dataIndex||f,value:g,operator:a.operator||15})}else{c[f]=g}}}if(!Ext.isEmpty(e.filters)){h=h.concat(e.filters)}if(!Ext.isEmpty(h)){c.queryCondition=h}return c},beforeSearch:function(){var g=this,b=g.searchNotNullField;if(!b){return true}var f=g.formPanel,c=false,e=b.split(","),a,d=[];if(!f){return true}e.forEach(function(h){a=Belle.getField(f,h);if(a){if(!Ext.isEmpty(a.getValue())){c=true}d.push("【"+a.fieldLabel+"】")}});if(!c){Belle.alert("查询条件"+d.join("")+",必须输入一组值")}return c}});
Ext.define("Belle_Common.ux.SearchHelpField",{extend:"Ext.form.field.Text",xtype:"searchhelpfield",enableKeyEvents:true,searchNotNullField:"",url:"",formAllowBlank:true,gridColumns:null,canQueryCondition:false,queryDataIndex:"a",searchItems:null,searchColumn:4,fieldWidth:"100%",winTitle:"选择器",winHeight:500,winWidth:700,isAutoLoad:true,isMultiSelect:false,otherFields:"",fromFields:"",fieldMap:"",filters:[],otherParams:{},listeners:{keydown:"onKeyDown",blur:"onTxtBlur",focus:"onTxtFocus",afterrender:"onrendered",change:"onValChange",scope:"this"},tabIndex:1,triggers:{search:{cls:"x-form-search-trigger",weight:1,handler:"showSelectWin",scope:"this"}},isCanInput:true,needCall:false,checkValue:true,oldValue:"",errorText:null,initComponent:function(){var a=this;a.needCall=false;a.callParent(arguments);a.oldValue="";if(a.column&&a.column.up()){a.url=Belle.setUrlModuleInfo(a.column.up().grid,a.url)}else{a.url=Belle.setUrlModuleInfo(a,a.url)}if(!a.gridColumns){a.getTrigger("search").hide()}if(a.isCanInput==false){a.checkValue=false}},afterRender:function(){var a=this;a.callParent(arguments);if(a.isCanInput==false&&a.inputEl&&a.inputEl.dom){a.inputEl.dom.readOnly=true}},onrendered:function(){var a=this;if(a.inputEl){a.inputEl.on("dblclick",function(){a.showSelectWin()},a)}},onValChange:function(){var a=this;a.needCall=true},showSelectWin:function(){var c=this;if(!c.fireEvent("onBeforeShowWin",c)){return}if(!c.gridColumns||!c.url||c.readOnly||c.disabled){return}Ext.each(c.gridColumns,function(g){Ext.each(c.searchItems,function(h){if(g.dataIndex==h.name){if(!g.belleFilter){g.belleFilter={}}g.belleFilter.isOpen=g.belleFilter.isOpen||false}})});var d=c.getFromFieldsVal(),f={};Ext.each(d,function(g){f[g.property]=g.value});Ext.applyIf(f,c.otherParams);var a={otherParams:f,gridColumns:c.gridColumns,url:c.url,searchItems:c.searchItems,title:c.winTitle,isAutoLoad:c.isAutoLoad,isMultiSelect:c.isMultiSelect,isQueryParams:c.isQueryParams||false,height:c.winHeight,width:c.winWidth,searchNotNullField:c.searchNotNullField,autoShow:true,formAllowBlank:c.formAllowBlank,canQueryCondition:c.canQueryCondition,queryDataIndex:c.queryDataIndex};var e=new Belle_Common.ux.SearchWin(a);e.on("onBeforeReturnData",function(g,h,i){c.checkFun(g,function(j){if(j===true){c.onReturnValue(i.down("[itemId='"+i.id+"btnSave']"));i.close()}});return false});var b=e.gridPanel;c.fireEvent("onAfterShowWin",c,e,b);c.selectionWin=e},getSearchItems:function(){},onFilterClose:function(b){var c=this,d=b.up("window"),a=d.down("grid");if(typeof(a.setFilterStatus)=="function"){a.setFilterStatus(false);c._setBtnFilterText(b.up("[itemId='"+d.id+"btnFilter']"))}},onSetFilterLocal:function(b){var c=this,d=b.up("window"),a=d.down("grid");if(typeof(a.setFilterStatus)=="function"){a.setFilterLocal(true)}c._setBtnFilterText(b.up("[itemId='"+d.id+"btnFilter']"))},onSetFilterServer:function(b){var c=this,d=b.up("window"),a=d.down("grid");if(typeof(a.setFilterStatus)=="function"){a.setFilterLocal(false)}c._setBtnFilterText(b.up("[itemId='"+d.id+"btnFilter']"))},_setBtnFilterText:function(b){var d,c=b.up("window"),a=c.down("grid");if(typeof(a.setFilterStatus)!="function"){b.setText("请加入filter插件");return}if(a.getFilterStatus()){d="过滤["+(a.isLocal?"本页":"所有")+"]"}else{d="过滤"}b.setText(d)},onReturnValue:function(c){var d=this,e=c.up("window"),b=e.gridPanel,a=b.getSelection();if(a.length<1){Belle.alert("必须选择一条记录");return}d.needCall=false;d.setOtherFieldsVal(a[0].data,a);e.close()},onTxtFocus:function(){var a=this,b=a.getValue();if(!Ext.isEmpty(b)){a.oldValue=b}else{a.oldValue=""}},onTxtBlur:function(){var a=this;if(!a.needCall){return}if(Ext.isEmpty(a.getValue())){a.needCall=false;a.oldValue="";a.clearOtherFieldsVal();return}a.sendToServer()},onKeyDown:function(b){var a=this;if(b.getKey()===b.ENTER){if(Ext.isEmpty(a.getValue())){a.oldValue="";a.clearOtherFieldsVal()}else{a.sendToServer()}}else{if(b.getKey()===b.F4){a.showSelectWin()}}},getFieldMap:function(){var c=[],a=this;if(!a.fieldMap){return c}var b=a.fieldMap.split(",");Ext.each(b,function(e){var d=e.split("=");if(d.length==2){var f={s:d[0],t:d[1]};c.push(f)}});return c},getFromFieldsVal:function(){var i=this,f=[];if(!Ext.isEmpty(i.filters)){Ext.each(i.filters,function(k){if(!Ext.isEmpty(k.property)){f.push({property:k.property,value:k.value,operator:k.operator||10})}})}if(!i.fromFields){return f}var g=i.fromFields.split(","),h=i.up(),c,d,b=i.up("form"),e=i.getFieldMap(),j="",a=i.up("grid");if(h){c=h.context;if(!c&&a&&a.editingPlugin){c=a.editingPlugin.context}}if(c||b){Ext.each(g,function(l){d="";j=l;if(c){d=c.record.get(l)}if(!d&&b){var k=Belle.getField(b,l);if(k){d=k.getValue()}}var m=Ext.Array.findBy(e,function(n){return n.s==l});if(d&&d.join){d=d.join(",")}f.push({property:(m&&m.t)||j,value:d||"",operator:10})})}return f},checkFun:function(b,c){var a=this;c(true)},sendToServer:function(){var b=this,a=b.up("grid")?true:false;if(!b.needCall||!b.checkValue||b.oldValue==b.getValue()){return}b.needCall=false;if(!b.url||Ext.isEmpty(b.getValue())){b.clearOtherFieldsVal();return}b.checkFun(b.getValue(),function(e){if(e===true){var h=b.getFromFieldsVal(),g=b.getValue(),f=Ext.Array.findBy(b.getFieldMap(),function(j){return j.s==b.name}),i=f&&f.t||b.property||b.name;h.push({property:i,value:g,operator:10});var d={};d.isSearchHelpInput="TRUE";Ext.each(h,function(j){d[j.property]=j.value});var c={url:b.url,async:!a,params:d,method:"POST",success:function(l){try{var j=JSON.parse(l.responseText);if(!j.list||j.list.length==0){b.clearOtherFieldsVal();Belle.alert(b.errorText||"输入【"+g+"】是无效的值",function(){})}else{b.setOtherFieldsVal(j.list[0])}}catch(k){Belle.alert("输入值【"+g+"】后端验证失败",function(){b.clearOtherFieldsVal()})}},failure:function(){Belle.alert("数据精灵验证失败，请联系管理员",function(){b.clearOtherFieldsVal()})}};Belle.callServer(c)}else{b.clearOtherFieldsVal()}})},setOtherFieldsVal:function(e,m){var n=this,c=n.up("form"),l=n.up(),d,j,h=n.getFieldMap(),a=n.up("grid"),i;if(a){i=a.getPlugins()}if(a&&!d){Ext.each(i,function(p){if(p.ptype==="cellediting"){l=p;return false}})}m=m||[];n.fireEvent("onReturnData",e,m);e=e||{};if(l){d=l.context}if(d){j=d.record}else{if(c){j=c.getRecord()}}n.startEditingCell();if(n.afterCall(n,e,j,d,m)===false){return}var b=Ext.Array.findBy(h,function(p){return p.s==n.name}),g=b&&b.t||n.property||n.name,f=e[g]==null?(n.getValue()||n.oldValue):e[g];if(d&&d.column&&!n.inputEl){n=d.column.field}if(n.isMultiSelect&&m&&m.length>0){var o=[];Ext.each(m,function(p){o.push(p.data[g])});n.setValue(o.join(","))}else{n.setValue(f)}if(d){j.set(n.name,f)}n.oldValue=n.getValue();n.needCall=false;if(!n.otherFields){return}var k=n.otherFields.split(",");Ext.each(k,function(r){b=Ext.Array.findBy(h,function(s){return s.s==r});g=b&&b.t||r;var q=e[g]==null?"":e[g];if(d){j.set(r,q)}else{if(c){var p=Belle.getField(c,r);if(p){p.setValue(q)}if(j){j.set(r,q)}}}})},clearOtherFieldsVal:function(){var i=this,c=i.up("form"),h=i.up(),d,f,b,a=i.up("grid"),e;if(a){e=a.getPlugins()}if(a&&!d){Ext.each(e,function(j){if(j.ptype==="cellediting"){h=j;return false}})}if(h){d=h.context}if(d){f=d.record}else{if(c){f=c.getRecord()}}i.startEditingCell();b=i.oldValue;if(d&&d.column&&!i.inputEl){i=d.column.field;d.column.field.setValue(b)}else{i.setValue(b)}if(d){f.set(i.name,b)}i.needCall=false;i.onValueError();if(b){return}if(!i.otherFields){return}var g=i.otherFields.split(",");Ext.each(g,function(k){if(d){f.set(k,"")}else{if(c){var j=Belle.getField(c,k);if(j){j.setValue("")}if(f){f.set(k,"")}}}})},onValueError:function(){},startEditingCell:function(){var e=this,c=e.up("grid"),d=e.up(),b,a;if(c){a=c.getPlugins()}if(c&&!b){Ext.each(a,function(f){if(f.ptype==="cellediting"){d=f;return false}})}if(d){b=d.context}if(!c||!b){return}c.editingPlugin.startEdit(b.record,b.column)},afterCall:function(b,d,a,c){}});

Ext.define("Belle_Common.ux.BelleExport",{extend:"Ext.window.Window",alias:"widget.belleexport",constructor:function(a){var b=this;Ext.apply(b,a);b.callParent(arguments)},title:"文件导出",exportType:"page",maxCount:20000,initComponent:function(){var a=this;a.fileType=a.fileType||"xls";a.fieldType=a.fieldType||"all";if(a.grid.exportMaxRows){a.maxCount=a.grid.exportMaxRows}a.items=[a._createForm()];a.bbar=["->",{glyph:Belle.Icon.btnSave,text:"确定",itemId:a.id+"_exportOk",handler:a._exportOk},{glyph:Belle.Icon.btnCancel,text:"退出",itemId:a.id+"_exportCanel",handler:a._exportCanel}];a.callParent(arguments)},title:"数据导出",modal:true,resizable:false,ATTRS:{btns:{},fields:{}},initEvents:function(){var a=this;a.ATTRS.btns.btnAllField.on("click",function(){a.fieldType="all";a._allfield()});a.ATTRS.btns.btnCustomField.on("click",function(){a.fieldType="custom";a._customField()});a.ATTRS.btns.btnSelectAll.on("click",function(){a._selectAll()});a.ATTRS.btns.btnUnSelectAll.on("click",function(){a._unSelectAll()});a.ATTRS.btns.exportAll.on("click",function(b){a.exportType="all";a._setExportTypeBtnCls(b)});a.ATTRS.btns.exportPage.on("click",function(b){a.exportType="page";a._setExportTypeBtnCls(b)});a.ATTRS.btns.exportPageSize.on("click",function(b){a.exportType="pageSize";a._setExportTypeBtnCls(b)});Ext.each(a.ATTRS.btns.btnFileTypes.items.items,function(b){b.on("click",function(){a._selectFileType(this.value)})})},_createForm:function(){var e=this,c=e.grid,b=c.getStore(),f=c.columnManager.getColumns()||[],d,a=[];e.gridColumns=f;Ext.each(f,function(h){if(Ext.isEmpty(h.dataIndex)){return true}if(h.isHidden()==true){return true}var g=h.dataIndex;if(h.belleFilter&&h.belleFilter.dataIndex){g=h.belleFilter.dataIndex}var i={tooltipType:"title",title:h.text,tooltip:h.text,text:h.text,value:h.dataIndex,dataIndex:g,name:h.dataIndex,handler:e._addOrDelFields,isSelect:false};a.push(i)});d=new Ext.form.Panel({border:false,defaults:{style:"margin:5px 10px 5px 5px;"},items:[{xtype:"fieldcontainer",fieldLabel:"导出文件",labelWidth:70,layout:"hbox",defaults:{xtype:"button",style:"margin:5px 10px 5px 0px;",cls:"belle-export"},itemId:e.id+"_fileTypes",items:[{text:"Excel(.xls)",itemId:e.id+"_xls",iconCls:e.fileType=="xls"?"belle-export-select":"",value:"xls"},{text:"Excel(.xlsx)",itemId:e.id+"_xlsx",iconCls:e.fileType=="xlsx"?"belle-export-select":"",value:"xlsx"}]},{xtype:"fieldcontainer",fieldLabel:"文件名称",layout:"vbox",labelWidth:70,defaults:{style:"margin:5px 10px 5px 0px;"},items:[{xtype:"textfield",emptyText:"请输入导出文件名称",value:e.fileName||"export",allowBlank:false,itemId:e.id+"_exportFileName"}]},{xtype:"fieldcontainer",fieldLabel:"导出字段",layout:"vbox",labelWidth:70,items:[{border:false,layout:"hbox",defaults:{xtype:"button",style:"margin:5px 10px 5px 0px;",cls:"belle-export"},items:[{text:"所有",itemId:e.id+"_allfield",iconCls:e.fieldType=="all"?"belle-export-select":""},{iconCls:e.fieldType!="all"?"belle-export-select":"",text:"自定义",itemId:e.id+"_Customfield"}]},{border:false,hidden:true,itemId:e.id+"_btnExport",layout:"hbox",defaults:{style:"margin:5px 10px 5px 0px;",xtype:"button",cls:"belle-export"},items:[{text:"全选",itemId:e.id+"_selectAll"},{text:"反选",itemId:e.id+"_unselectAll"}]},{border:false,layout:"column",labelWidth:70,maxHeight:300,width:600,autoScroll:true,hidden:true,itemId:e.id+"_exportFiels",defaults:{style:"margin:5px 5px 5px 0px;",xtype:"button",cls:"belle-export",columnWidth:0.25},items:a}]},{xtype:"fieldcontainer",fieldLabel:"导出方式",layout:"hbox",labelWidth:70,defaults:{xtype:"button",style:"margin:5px 10px 5px 0px;",cls:"belle-export"},items:[{text:"导出所有",itemId:e.id+"exportAll",iconCls:e.exportType=="all"?"belle-export-select":""},{text:"导出当前页",itemId:e.id+"exportPage",iconCls:e.exportType=="page"?"belle-export-select":""},{text:"导出指定页数(最大"+e.maxCount+")行",itemId:e.id+"exportPageSize",iconCls:e.exportType=="pageSize"?"belle-export-select":""}]},{hidden:true,itemId:e.id+"exportPageInput",xtype:"fieldcontainer",layout:"column",defaults:{labelWidth:70,style:"margin:5px 10px 5px 0px;"},items:[{minValue:1,xtype:"numberfield",fieldLabel:"开始页",itemId:e.id+"exportPageStar",columnWidth:0.45,value:1},{value:1,minValue:1,xtype:"numberfield",fieldLabel:"结束页",itemId:e.id+"exportPageStop",columnWidth:0.45,validator:function(g){if(e.exportType==="pageSize"){if(g<e.ATTRS.fields.exportPageStar.getValue()){return"此项必须大于或等于开始页"}else{return true}}else{return true}}}]}]});e.ATTRS.fields.exportFiels=d.down("[itemId="+e.id+"_exportFiels]");e.ATTRS.fields.exportFileName=d.down("[itemId="+e.id+"_exportFileName]");e.ATTRS.fields.btnExport=d.down("[itemId="+e.id+"_btnExport]");e.ATTRS.fields.exportPageInput=d.down("[itemId="+e.id+"exportPageInput]");e.ATTRS.fields.exportPageStar=d.down("[itemId="+e.id+"exportPageStar]");e.ATTRS.fields.exportPageStop=d.down("[itemId="+e.id+"exportPageStop]");e.ATTRS.btns.btnFileTypes=d.down("[itemId="+e.id+"_fileTypes]");e.ATTRS.btns.btnSelectAll=d.down("[itemId="+e.id+"_selectAll]");e.ATTRS.btns.btnUnSelectAll=d.down("[itemId="+e.id+"_unselectAll]");e.ATTRS.btns.btnAllField=d.down("[itemId="+e.id+"_allfield]");e.ATTRS.btns.btnCustomField=d.down("[itemId="+e.id+"_Customfield]");e.ATTRS.btns.exportAll=d.down("[itemId="+e.id+"exportAll]");e.ATTRS.btns.exportPage=d.down("[itemId="+e.id+"exportPage]");e.ATTRS.btns.exportPageSize=d.down("[itemId="+e.id+"exportPageSize]");return d},_selectAll:function(){var a=this,b=a.ATTRS.fields.exportFiels.items.items;a.ATTRS.btns.btnSelectAll.setIconCls("belle-export-select");a.ATTRS.btns.btnUnSelectAll.setIconCls("");Ext.each(b,function(c){c.isSelect=true;c.setIconCls("belle-export-select")})},_unSelectAll:function(){var a=this,b=a.ATTRS.fields.exportFiels.items.items;a.ATTRS.btns.btnSelectAll.setIconCls("");a.ATTRS.btns.btnUnSelectAll.setIconCls("belle-export-select");Ext.each(b,function(c){c.isSelect=!c.isSelect;if(c.isSelect){c.setIconCls("belle-export-select")}else{c.setIconCls("")}})},_selectFileType:function(a){var c=this,b=c.ATTRS.btns.btnFileTypes.items.items;Ext.each(b,function(d){d.setIconCls(d.value==a?"belle-export-select":"")});c.fileType=a},_addOrDelFields:function(){var a=this;a.isSelect=!a.isSelect;if(a.isSelect){a.setIconCls("belle-export-select")}else{a.setIconCls("")}},_allfield:function(){var e=this,f=e.getWidth(),c=e.getHeight(),d,b,a=e.getXY();e.ATTRS.btns.btnAllField.setIconCls("belle-export-select");e.ATTRS.btns.btnCustomField.setIconCls("");e.ATTRS.fields.exportFiels.setVisible(false);e.ATTRS.fields.btnExport.setVisible(false);d=e.getWidth();b=e.getHeight();a[0]-=(d-f)*0.5;a[1]-=(b-c)*0.5;e.setXY(a)},_setExportTypeBtnCls:function(a){var b=this;b.ATTRS.btns.exportAll.setIconCls("");b.ATTRS.btns.exportPage.setIconCls("");b.ATTRS.btns.exportPageSize.setIconCls("");a.setIconCls("belle-export-select");b.ATTRS.fields.exportPageInput.setVisible(b.exportType==="pageSize")},_customField:function(){var e=this,f=e.getWidth(),c=e.getHeight(),d,b,a=e.getXY();e.ATTRS.btns.btnAllField.setIconCls("");e.ATTRS.btns.btnCustomField.setIconCls("belle-export-select");e.ATTRS.fields.exportFiels.setVisible(true);e.ATTRS.fields.btnExport.setVisible(true);d=e.getWidth();b=e.getHeight();a[0]-=(d-f)*0.5;a[1]-=(b-c)*0.5;e.setXY(a)},_exportOk:function(){var b=this,c=b.up("window"),a=c.down("form");if(!a.isValid()){return}if(c._export()==true){c.close()}},_export:function(){var A=this,c="",e=A.grid,n=A.objs,b=A.exportUrl||e.exportUrl,d=n.commonsearch,B=A.ATTRS.fields.exportFileName.getValue(),i=A.fileType,w=[],m=[];if(d&&!d.isValid()){return}var g=document.createElement("form");document.body.appendChild(g);g.method="post";g.action=b;g.hidden=true;if(A.fieldType==="all"){Ext.each(A.gridColumns,function(C){if(C.isHidden()==true){return}if(C.dataIndex){w.push({field:C.dataIndex,title:C.text.replace("&nbsp;","").replace(/\%/g,"百分比")})}})}else{var v=A.ATTRS.fields.exportFiels.items.items;Ext.each(v,function(C){if(C.isSelect===true){w.push({field:C.value,title:C.text.replace(/\%/g,"百分比")})}})}if(!b){Belle.alert("此网格没有提供导出功能");return true}if(w.length<=0){c+="请选择导出的列"}if(c!=""){Ext.Msg.alert("导出提示",c);return false}if(e.supGrid){var s=n[e.supGrid],p=s.primaryKey,j=s.getSelection()[0].data[p];var z=document.createElement("input");z.value=j;z.name=p;g.appendChild(z)}B=B||"export";var f=[];if(d){var r=d.getForm().getFields().items,h=d.getValues();Ext.each(r,function(G){var D=G.dataIndex||G.name,F=h[G.name];if(Ext.isEmpty(F)){return true}if(F.join){F="'"+F.join("','")+"'"}if(G.xtype==="bellefilter"){f.push({value:F,operator:G.operator,property:D})}else{var E=Ext.encode(F);if(E.length>0){E=E.substring(1,E.length-1)}var C=document.createElement("input");C.value=E;C.name=D;g.appendChild(C)}})}f=f.concat(e.getFilters());var u=e.store.getSorters();if(u&&u.items.length>0){Ext.Array.each(u.items,function(D){var C=D.getProperty();Ext.each(A.gridColumns,function(E){if(E.dataIndex===C){if(E.belleFilter&&E.belleFilter.dataIndex){C=E.belleFilter.dataIndex}return false}});m.push(C+" "+D.getDirection().toLowerCase())})}var q=document.createElement("input");q.value=Ext.encode(w);q.name="exportColumns";g.appendChild(q);var t=document.createElement("input");t.value=Ext.encode(B).substring(1,Ext.encode(B).length-1);t.name="fileName";g.appendChild(t);var y=document.createElement("input");y.value=i;y.name="fileType";g.appendChild(y);var o=document.createElement("input");o.value=m.join(",");o.name="sort";g.appendChild(o);var k=document.createElement("input");k.value=Ext.encode(f);k.name="queryCondition";g.appendChild(k);if(A.exportType=="all"){}else{if(A.exportType=="page"){g.action=b+(b.indexOf("?")>0?"&":"?")+"pageNum="+e.store.currentPage+"&pageSize="+e.store.pageSize}else{var l=A.ATTRS.fields.exportPageStar.getValue(),a=A.ATTRS.fields.exportPageStop.getValue(),x=e.store.pageSize;if(((a-l+1)*x)>A.maxCount){Belle.alert("导出行数不能大于"+A.maxCount);return false}g.action=b+(b.indexOf("?")>0?"&":"?")+"pageNum="+(l)+"&pageNumTo="+a+"&pageSize="+x}}g.submit();return true},_exportCanel:function(){var a=this;Belle.confirm("是否关闭？",function(b){if(b!="yes"){return}a.up("window").close()})}});
Ext.define("Belle_Common.ux.BelleFilter",{extend:"Ext.form.field.Text",alias:"widget.bellefilter",requires:["Ext.menu.Menu"],emptyText:"请输入查找内容...",_filterCls:"belle-common-filter",filterType:"like",initComponent:function(){var a=this;a.callParent(arguments);a.createMenu();a.setFilterType(a.filterType);a.getTrigger("bellefilter").hide();if(a.menu){a.menu.on("mouseover",function(){a._menuMouseMove()});a.menu.on("mouseleave",function(){a._menuMouseLeave()})}},initEvents:function(){var a=this;a.callParent(arguments);a.on("change",a._change);a.on("blur",a._blur);a.on("focus",a._focus);a.el.on("keyup",a._keyup)},triggers:{bellefilter:{cls:"belle-common-triggers-filter",handler:function(b,c,e){var d=this,a=d.el.dom.offsetWidth-61;d.menu.showBy(d,"tl-bl?",[a,0])}}},createMenu:function(){var a=this;if(!a.menu){a.menu=new Ext.menu.Menu({scope:a,maxWidth:100,minWidth:50,items:[{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/filters/find.png",text:"包含",value:"like",cssName:"like",operator:"15",pressed:true,handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}},{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/dd-insert-arrow-right.gif",text:"开头包含",value:"likeleft",cssName:"likeleft",operator:"19",pressed:true,handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}},{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/dd-insert-arrow-left.gif",text:"结尾包含",value:"likeright",cssName:"likeright",operator:"20",pressed:true,handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}},{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/filters/equals.png",text:"等于",value:"=",operator:"10",cssName:"equal",handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}},{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/filters/greater_than.png",text:"大于",value:">",operator:"11",cssName:"more",handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}},{icon:"./resources/static/js/extjs/packages/ext-theme-classic/images/grid/filters/less_than.png",text:"小于",value:"<",operator:"12",cssName:"less",handler:function(b){a.setFilterType(this.value);a.fireEvent("onSelectFilter",a.getValue(),a.filterType,b.operator,a)}}]})}return a.menu},getFilterType:function(){return this.filterType},setFilterType:function(d){var c=this,a=c.menu.items.items,b;Ext.each(a,function(f,e){if(d===e){b=f;return false}if(f.value===d||f.operator===d||f.text===d){b=f;return false}});if(!b){return}c._setFilterCls(c._oddCls||b.cssName,b.cssName);c.filterType=d;c.operator=b.operator},_menuMouseLeave:function(){var a=this;a.isSelect=false},_menuMouseMove:function(){var a=this;a.isSelect=true;a.getTrigger("bellefilter").show()},_keyup:function(b){var a=this,c=a.component;c.fireEvent("onBelleFilterKeyup",c.getValue(),c.filterType,c.operator,c,b)},_change:function(b,a){b.fireEvent("onBelleFilterChange",b.getValue(),b.filterType,b.operator,b,a)},_focus:function(b,a){b.getTrigger("bellefilter").show()},_blur:function(c,b){var a=this;if(!c.getValue()){c.getTrigger("bellefilter").hide()}if(a.menu&&!a.isSelect){a.menu.hide()}},_setFilterCls:function(a,c){var b=this;if(!a){a=c}b._oddCls=c;b.addCls(b._filterCls+"-"+c);if(a!=c){b.removeCls(b._filterCls+"-"+a)}}});
Ext.define("Belle_Common.ux.BelleHeaderFilter",{extend:"Ext.plugin.Abstract",requires:["Ext.grid.column.Column","Ext.form.Text","Ext.menu.Menu","Belle_Common.ux.BelleFilter"],childEls:["titleEl","triggerEl","textEl","bellefilterEl"],headerTpl:['<div id="{id}-titleEl" data-ref="titleEl" {tipMarkup}class="',Ext.baseCSSPrefix,"column-header-inner",'<tpl if="empty"> ',Ext.baseCSSPrefix,'column-header-inner-empty</tpl>">','<span id="{id}-textEl" data-ref="textEl" class="',Ext.baseCSSPrefix,"column-header-text",'{childElCls}">',"{text}","</span>",'<tpl if="!menuDisabled">','<div id="{id}-triggerEl" data-ref="triggerEl" role="presentation" class="',Ext.baseCSSPrefix,"column-header-trigger",'{childElCls}" style="{triggerStyle}"></div>',"</tpl>","</div>",'<div id="{id}-bellefilterEl" data-ref="bellefilterEl" class="bellefilter-common-body"></div>',"{%this.renderContainer(out,values)%}"],alias:"plugin.belleheaderfilter",constructor:function(a){var b=this;b.callParent(arguments)},init:function(b){var c=this,a=b.columns;c.grid=b;Ext.each(a,function(e){e.renderTpl=c.headerTpl;var d=e.getChildEls();d.bellefilterEl={itemId:"bellefilterEl",name:"bellefilterEl"};e.setChildEls(d);e.on("afterrender",function(f){c.createHeaderEl(this)})});c.initGridMethods(b);c.initStoreEvents(b);c.callParent(arguments);if(c.grid.isFilter){b.removeCls("grid-filter-hide")}else{b.addCls("grid-filter-hide")}},initStoreEvents:function(b){var c=this;var a=b.getStore();a.on("load",function(){a.oddData=a.getData().items.belleCopy()});a.on("beforeload",function(){})},createHeaderEl:function(d){var f=this,e=f.grid,b;if(!d.dataIndex){return}var a=d.bellefilterEl;if(a&&!d.bellefilterObj){var c={width:"100%",renderTo:a.dom};if(!d.belleFilter){d.belleFilter={xtype:"bellefilter"}}else{if(!d.belleFilter.xtype){d.belleFilter.xtype="bellefilter"}}if(!d.belleFilter.filterType){d.belleFilter.filterType="like"}c.property=d.dataIndex;c.propertyName=d.belleFilter.dataIndex||d.dataIndex;switch(d.belleFilter.filterType){case"like":b="15";break;case"=":b="10";break;case">":b="11";break;case"<":b="12";break;default:b="10";break}d.belleFilter.operator=b;d.belleFilter.hidden=d.belleFilter.isOpen==false?true:false;Ext.applyIf(c,d.belleFilter);d.bellefilterObj=Ext.widget(c);d.bellefilterObj.grid=e;if(d.belleFilter.xtype==="bellefilter"){d.bellefilterObj.on("onSelectFilter",function(j,i,g,h){f._changeValueFilter()});d.bellefilterObj.on("onBelleFilterKeyup",function(l,i,g,h,j){var k=j.keyCode;f._keyFilter(k)});d.bellefilterObj.on("onBelleFilterChange",function(k,i,g,h,j){})}else{d.bellefilterObj.el.on("keyup",function(i,g){var h=g.keyCode;f._keyFilter(h)});d.bellefilterObj.on("change",function(i,h){var g=e.getFilterLocal(),j=i.inputEl.dom.readOnly;f._changeValueFilter()})}}},_keyFilter:function(d){var c=this,a=c.grid,b=a.getFilterLocal();if(!b){if(d!=13){return}c._filterServer()}else{c._filterLocal()}},_changeValueFilter:function(){var c=this,a=c.grid,b=a.getFilterLocal();if(!b){c._filterServer()}else{c._filterLocal()}},initExtraParams:function(){var d=this,b=d.grid,a=b.getStore(),e=a.getProxy().extraParams,c=d._getFilters()||[];if(!e){return}if(b.otherfilter){c=c.concat(b.otherfilter)}if(b.getFilterStatus()==true&&!b.getFilterLocal()){e.queryCondition=Ext.encode(c)}else{if(!Ext.isEmpty(b.otherfilter)){e.queryCondition=Ext.encode(b.otherfilter)}else{delete e.queryCondition}}},_getFilters:function(){var e=this,b=e.grid,a=b.columns,d=[],c=b.getFilterLocal();if(!b.isFilter){return[]}Ext.each(a,function(g){var h=g.bellefilterObj,f={},i;if(h&&h.inputEl&&h.inputEl.dom&&!h.hidden){if(h.config.xtype=="combo"||h.config.xtype=="combobox"||h.config.xtype=="extcombox"){i=h.getValue()}else{i=h.getRawValue()}if(!Ext.isEmpty(i)){f={value:i,operator:h.operator,property:c?h.property:h.propertyName};d.push(f)}}});return d},_filterLocal:function(){var d=this,c=d.grid,a=c.getStore(),b=d._getFilters();if(!a.oddData){return}var e=[];e=a.oddData.filter(function(g){var f=true;Ext.each(b,function(h){var i=g.data[h.property];if(Ext.isEmpty(i)){i=""}if(Ext.isEmpty(h.value)){h.value=""}switch(h.operator){case"15":if(typeof(i)!="string"){f=i.toString().toLowerCase().indexOf(h.value.toLowerCase())>=0}else{f=i.toLowerCase().indexOf(h.value.toLowerCase())>=0}break;case"10":f=i==h.value;break;case"12":var j=typeof(i);switch(j){case"number":f=i<parseInt(h.value);break;case"string":f=d._comparisonDateValue(i,h.value);break;default:f=false;break}break;case"11":var j=typeof(i);switch(j){case"number":f=i>parseInt(h.value);break;case"string":f=!d._comparisonDateValue(i,h.value);break;default:f=false;break}break}if(!f){return false}});return f});d.initExtraParams();a.loadData(e)},_comparisonDateValue:function(b,a){var d=Ext.Date.parse(b,"Y-m-d H:i:s")||Ext.Date.parse(b,"Y-m-d");var c=Ext.Date.parse(a,"Y-m-d H:i:s")||Ext.Date.parse(a,"Y-m-d");if(d&&c){return d.getTime()<c.getTime()}else{return false}},_filterServer:function(){var c=this,b=c.grid,a=b.getStore();if(!b.isFilter){return}c.initExtraParams();a.loadPage(1)},initGridMethods:function(a){var b=this;a.getFilterStatus=function(){return a.isFilter};a.setFilterStatus=function(c){var d=a.getStore();if(c){a.isFilter=true;a.removeCls("grid-filter-hide")}else{a.isFilter=false;a.addCls("grid-filter-hide");b.clearFilterValue()}a.fireEvent("onFilterStatusChange",a.isLocal,a.isFilter,a);b.initExtraParams()};a.getFilterLocal=function(){return a.isLocal};a.setFilterLocal=function(c){a.setFilterStatus(true);a.isLocal=c;b.initExtraParams();a.fireEvent("onFilterLocalChange",b.isLocal,b.isFilter,b);if(c){Ext.each(a.columns,function(d){if(d.bellefilterObj){d.bellefilterObj.show()}})}else{Ext.each(a.columns,function(d){if(d.bellefilterObj&&d.bellefilterObj.isOpen==false){d.bellefilterObj.hide()}})}};a.setOtherFilters=function(c){a.otherfilter=c;b.initExtraParams()};a.getFilters=function(){return b._getFilters()}},clearFilterValue:function(){var d=this,c=d.grid,b=c.columns,a=c.getStore();Ext.each(b,function(f){var g=f.bellefilterObj,e={},h;if(g&&g.inputEl&&g.inputEl.dom&&!g.hidden){g.setValue("")}});if(c.getFilterLocal()&&!Ext.isEmpty(a.oddData)){a.load(a.oddData)}}});
Ext.define("Belle_Common.ux.BelleImport",{extend:"Ext.window.Window",alias:"widget.belleimport",constructor:function(b){var c=this;Ext.apply(c,b);Ext.apply(c,{ImportUrl:c.workObject.importUrl,modelName:c.workObject.modelName.substr(c.workObject.modelName.lastIndexOf(".")+1)});var a=c.initGridData();Ext.apply(c,{initData:a});c.callParent(arguments)},initComponent:function(){var a=this;a.items=[a._createHeader(),a._createForm()];a.bbar=["->",{glyph:Belle.Icon.btnSave,text:"确定",itemId:a.id+"_ok",handler:a._ok},{glyph:Belle.Icon.btnCancel,text:"退出",itemId:a.id+"_canel",handler:a._canel}];a.callParent(arguments)},initData:{leftGridData:[],rightGridData:[]},layout:"vbox",title:"数据导入",modal:true,resizable:false,_gridHeight:300,formWidth:750,ATTRS:{btns:{},fields:{},grids:{}},initEvents:function(){var a=this;a.ATTRS.grids.leftGrid.on("celldblclick",function(b,c,i,d,h,j,f,g){if(d.get("isReadOnly")){return}var k=a.ATTRS.grids.rightGrid.getStore();k.add(d.data);b.getStore().remove(d);b.refresh();a.ATTRS.grids.rightGrid.getView().refresh()});a.ATTRS.grids.rightGrid.on("celldblclick",function(b,c,i,d,h,j,f,g){if(d.get("allowBlank")==false){return}var k=a.ATTRS.grids.leftGrid.getStore();k.add(d.data);b.getStore().remove(d);b.refresh();a.ATTRS.grids.leftGrid.getView().refresh()});a.ATTRS.btns.btnAdd.on("click",function(){a._add()});a.ATTRS.btns.btnRemove.on("click",function(){a._remove()});a.ATTRS.btns.btnUp.on("click",function(){a._up()});a.ATTRS.btns.btnDown.on("click",function(){a._down()})},_fields:["dataIndex","header","isReadOnly","allowBlank","mainKey","unique","isexist","modelName"],_createHeader:function(){var a=this;var b=a.title||"数据导入(文件不能大于5M)";var c=Ext.create("Ext.Component",{itemId:a.id+"_header",html:"<div class='belle-import-des' style='width:"+a.formWidth+"px;'>"+b+"</div>"});return c},initGridData:function(){var e=this,d=e.workObject.columns||[],c,b,f=[],a=[];Ext.each(d,function(j){var l=j.text,g=true,k=false,i=j.config.editor;if(i){k=false;if(i.allowBlank==false){g=false}else{g=true}}else{k=true}if(j.isImport==true){k=false}else{if(j.isImport===false){k=true;g=true}}if(j.isRequired==true){k=false;g=false}else{if(j.isRequired==false){g=true}}var h={header:l,dataIndex:j.dataIndex,isReadOnly:k,allowBlank:g,mainKey:j.mainKey?true:false,isexist:j.isexist?true:false,unique:j.unique?true:false,modelName:j.modelName||e.modelName};if(h.allowBlank==false){a.push(h)}else{f.push(h)}});return{leftGridData:f,rightGridData:a}},_createLeftGrid:function(){var d=this,c=d.workObject.columns||[],b,a,e=[];a=new Ext.data.Store({fields:d._fields,data:d.initData.leftGridData,});b=new Ext.create("Ext.grid.Panel",{columnWidth:0.3,height:d._gridHeight,selModel:Ext.create("Ext.selection.RowModel",{mode:"SIMPLE"}),columns:[{header:"数据列",dataIndex:"isReadOnly",width:"100%",renderer:function(l,k,j,m,g,f,h){var i=j.get("header");if(j.get("allowBlank")==false){k.style="color:blue;"}else{if(j.get("isReadOnly")==false){k.style="color:green !important;"}}if(j.get("isReadOnly")){i+="<span style='color:red;'>[只读]</span>"}return i}}],store:a});a.sort({property:"isReadOnly",direction:"ASC"});d.ATTRS.grids.leftGrid=b;return b},_createRightGrid:function(){var c=this,b,a;a=new Ext.data.Store({fields:c._fields,data:c.initData.rightGridData});b=new Ext.create("Ext.grid.Panel",{columnWidth:0.5,height:c._gridHeight,selModel:Ext.create("Ext.selection.RowModel",{mode:"SIMPLE"}),viewConfig:{plugins:{ptype:"gridviewdragdrop",dragText:"拖动行排序"}},columns:[{header:"Excel列",dataIndex:"header",width:"27.5%",renderer:function(f,e,d){if(d.get("allowBlank")==false){e.style="color:blue;"}else{if(d.get("isReadOnly")==false){e.style="color:green !important;"}}return f}},{header:"字段类型",dataIndex:"allowBlank",width:"18%",renderer:function(f,e,d){if(d.get("allowBlank")==false){e.style="color:blue;"}else{if(d.get("isReadOnly")==false){e.style="color:green !important;"}}if(!f){return"必填"}else{return"选填"}}},{header:"是否唯一",dataIndex:"unique",width:"18%",renderer:function(f,e,d){if(d.get("allowBlank")==false){e.style="color:blue;"}else{if(d.get("isReadOnly")==false){e.style="color:green !important;"}}return f?"是":"否"}},{header:"是否存在",dataIndex:"isexist",width:"18%",renderer:function(f,e,d){if(d.get("allowBlank")==false){e.style="color:blue;"}else{if(d.get("isReadOnly")==false){e.style="color:green !important;"}}return f?"是":"否"}},{header:"验证方式",dataIndex:"mainKey",width:"18%",renderer:function(f,e,d){if(d.get("allowBlank")==false){e.style="color:blue;"}else{if(d.get("isReadOnly")==false){e.style="color:green !important;"}}if(f){return"不允许重复"}else{return"允许重复"}}}],plugins:{ptype:"cellediting",clicksToEdit:1},store:a});c.ATTRS.grids.rightGrid=b;return b},_createForm:function(){var b=this,a;a=new Ext.form.Panel({baseParams:{},method:"POST",timeout:"120",url:b.ImportUrl,border:false,width:b.formWidth,defaults:{style:"margin:5px 0px 5px 5px;",},items:[{border:false,layout:"column",items:[b._createLeftGrid(),{border:true,height:b._gridHeight,columnWidth:0.2,layout:{align:"middle",pack:"center",type:"vbox"},defaults:{xtype:"button",width:80,height:30,cls:"belle-export"},items:[{text:"添加",iconCls:"belle-btn-icon-right",style:"margin-bottom:20px;",itemId:b.id+"_add"},{text:"删除",iconCls:"belle-btn-icon-left",style:"margin-bottom:20px;",itemId:b.id+"_remove"},{text:"上",iconCls:"belle-btn-icon-up",style:"margin-bottom:20px;margin-top:20px;",itemId:b.id+"_up"},{text:"下",iconCls:"belle-btn-icon-down",itemId:b.id+"_down"}]},b._createRightGrid()]},{layout:"column",xtype:"fieldset",title:"高级设置",collapsible:true,defaults:{labelWidth:180,columnWidth:1},items:[{itemId:b.id+"_importfile",style:"margin-top:5px;",fieldLabel:"导入文件(.xls,.xlsx)",xtype:"filefield",name:"importFileValue",msgTarget:"side",allowBlank:false,buttonText:"选择...",validator:function(h){if(Ext.isEmpty(h)){return}var g=h.lastIndexOf("\\"),f=h.substring(g+1),e=f.substring(f.lastIndexOf(".")),d;if(e!=".xls"&&e!=".xlsx"){d="文件格式错误，只支持.xls、.xlsx"}else{d=true}var c=this.fileInputEl.dom.files[0].size||1;if(c>5124880){d="上传的文件太大(导入文件不能大于5M)"}return d}},{itemId:b.id+"_isValidData",name:"isValidateAll",fieldLabel:"是否全部验证通过才导入",layout:"hbox",style:"margin-top:5px;",xtype:"radiogroup",defaults:{style:"margin-left:10px;"},items:[{checked:true,inputValue:"Y",name:"isValidateAll",boxLabel:"是(Y)",itemId:b.id+"checkboxY"},{inputValue:"N",name:"isValidateAll",boxLabel:"否(N)",itemId:b.id+"checkboxN"}]}]}]});b.ATTRS.btns.btnAdd=a.down("[itemId="+b.id+"_add]");b.ATTRS.btns.btnRemove=a.down("[itemId="+b.id+"_remove]");b.ATTRS.btns.btnUp=a.down("[itemId="+b.id+"_up]");b.ATTRS.btns.btnDown=a.down("[itemId="+b.id+"_down]");b.ATTRS.fields.isValidData=a.down("[itemId="+b.id+"_isValidData]");b.form=a;return a},_add:function(){var c=this,b=c.ATTRS.grids.leftGrid,a=b.getStore(),d=b.getSelection();if(!d||d.length<=0){Belle.alert("请选择左边数据列");return}Ext.each(d,function(e){if(!e.data.isReadOnly){c.ATTRS.grids.rightGrid.getStore().add(e.data);a.remove(e)}});b.getView().refresh();c.ATTRS.grids.rightGrid.getView().refresh()},_remove:function(){var c=this,b=c.ATTRS.grids.rightGrid,a=b.getStore(),d=b.getSelection();if(!d||d.length<=0){Belle.alert("请选择右边Excel列");return}Ext.each(d,function(e){if(e.get("allowBlank")==false){return}c.ATTRS.grids.leftGrid.getStore().add(e.data);a.remove(e)});b.getView().refresh();c.ATTRS.grids.leftGrid.getView().refresh()},_up:function(){var c=this,b=c.ATTRS.grids.rightGrid,a=b.getStore(),d=b.getSelection();Ext.each(d,function(f){var e=a.indexOf(f);if(e>0){a.remove(f);a.insert(e-1,f)}});b.setSelection(d);b.getView().refresh()},_down:function(){var c=this,b=c.ATTRS.grids.rightGrid,a=b.getStore(),d=b.getSelection();Ext.each(d,function(f){var e=a.indexOf(f);if(e<a.getCount()-1){a.remove(f);a.insert(e+1,f)}});b.setSelection(d);b.getView().refresh()},_ok:function(){var b=this,c=b.up("window"),a=c.down("form");if(!a.isValid()){return}c._export()},_canel:function(){var a=this;Belle.confirm("是否关闭？",function(b){if(b!="yes"){return}a.up("window").close()})},_export:function(){var d=this,c=d.form,g=[],h=[],e=[],b=d.ATTRS.grids.rightGrid.getStore(),f={},a=[];if(b.count()<=0){Belle.alert("请选择导入的列");return}Belle.confirm("是否确定导入数据？",function(i){if(i!="yes"){return}Ext.each(b.getData().items,function(n){var m=n.get("unique"),l=n.get("isexist"),k=n.get("modelName");if(l){a.push({validationType:"isexist",conditionValue:n.get("dataIndex"),validationModel:k})}if(m){if(Ext.isEmpty(f[d.modelName])){f[d.modelName]={validationType:"unique",conditionValue:n.get("dataIndex"),validationModel:d.modelName}}else{f[d.modelName].conditionValue+=","+n.get("dataIndex")}}g.push(n.get("dataIndex"));h.push(!n.get("allowBlank"));if(n.get("mainKey")){e.push(n.get("dataIndex"))}});for(var j in f){a.push(f[j])}c.getForm().baseParams={};if(d.fireEvent("beforeImprort",c,d)===false){return}if(!c.getForm().baseParams){c.getForm().baseParams={}}c.getForm().baseParams.colNames=g.join(",");c.getForm().baseParams.mustArray=h.join(",");c.getForm().baseParams.mainKey=e.join(",");c.getForm().baseParams.validationConditions=Ext.encode(a);c.getForm().submit({success:function(k,l){Belle.alert("导入成功！");d.workObject.store.loadPage(1)},failure:function(k,l){d.workObject.store.loadPage(1);try{Belle.alert(l.result.result.msg)}catch(m){Belle.alert("导入失败")}}})})}});
Ext.define("Belle_Common.ux.BelleSizeEditor",{extend:"Ext.window.Window",alias:"widget.sizeeditor",constructor:function(a){var b=this;Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;if(Ext.isEmpty(a.billNo)){Belle.alert("请设置单据编号");return}if(Ext.isEmpty(a.customerNo)){Belle.alert("请设置客户编号");return}if(Ext.isEmpty(a.regionNo)){Belle.alert("拉取客户信息失败");return}a._initData();a.items=[a._createForm()];a.callParent(arguments);a._initTooblrStatus()},isEditor:false,layout:"vbox",title:"新增",modal:true,resizable:false,ATTRS:{btns:{},fields:{},grids:{}},initData:{body:{packingType:"C",packingQty:0,sizeQty:0,boxQty:0,unitPrice:0,materialCode:"",materialName:"",pointNo:"",pointName:"",materialNo:"",sizeTypeNo:""},list:[]},customerNo:"",billNo:"",getSizeUrl:Belle.mdmPath+"bas_material/listMSizeVo.json?selectVoName=SelectListByVoMSizeByMaterial&mapperClassType=BasMaterialMapper",getPrice:Belle.sdsPath+"bl_co_dtl/getPrice.json",saveUrl:Belle.sdsPath+"bl_co_dtl/singlesave.json",updateUrl:Belle.sdsPath+"bl_co_dtl/singleupdate.json",initEvents:function(){var d=this,b=d.gridForm.getStore(),a=d.ATTRS.fields,c=d.ATTRS.btns;c.btnClose.on("click",function(){d._canel()});c.btnSave.on("click",function(){d._save()});c.btnReduction.on("click",function(){d._reduction()});c.btnSaveAndClose.on("click",function(){d._saveAndClose()});a.materialNo.on("onBeforeShowWin",function(e){if(!d.gridForm.isUpdate){return true}else{Belle.alert("网格数据编辑中！");return false}});a.pointNo.on("change",function(f){var e=f.getValue();if(Ext.isEmpty(e)){a.pointName.setValue("")}});a.boxQty.on("change",function(e){d._initValues()});a.packingQty.on("change",function(e){d._initValues()});a.packingType.on("change",function(e){val=e.getValue();if(Ext.isEmpty(val)){return}d._initValues(val)});b.on("update",function(){d._initValues();d._initGridDataChangeStatus();d._initTooblrStatus()});b.on("datachanged",function(){d._initValues();d._initGridDataChangeStatus();d._initTooblrStatus()});d.form.on("dirtychange",function(f,e){d.form.isUpdate=e;d._initTooblrStatus()});d.on("beforeclose",function(){if(!d.form.isUpdate&&!d.gridForm.isUpdate){return true}if(d.isCanClose){return true}else{Belle.confirm("数据编辑中，是否确认退出？",function(e){if(e=="no"){return}d.isCanClose=true;d.close()});return false}})},_initData:function(){var b=this,d=0,e=0,a;if(!b.initData||!b.initData.body||!b.initData.body.packingType){return}var a=b.initData.body,c=b.initData.list;if(b.brandNo==="XB01"){a.packingQty=1;a.packingType="B"}Ext.each(c,function(f){if(a.packingType==="C"){f.qty=f.qty/a.boxQty}e+=f.qty});switch(b.initData.body.packingType){case"C":a.packingQty=e;a.sizeQty=a.boxQty*a.packingQty;break;default:a.sizeQty=e;a.boxQty=a.sizeQty/a.packingQty;break}},_initValues:function(){var f=this,e=f.ATTRS.fields,a=f.gridForm,h=a.getStore(),g=0,d=0,i=e.packingType.getValue();Ext.each(h.data.items,function(j){g+=j.data.qty});switch(i){case"C":e.packingQty.setValue(g);var c=e.boxQty.getValue(),b=e.packingQty.getValue();e.boxQty.setReadOnly(false);e.packingQty.setReadOnly(true);if(!Ext.isEmpty(c)&&!Ext.isEmpty(b)){d=c*b}e.sizeQty.setValue(d);break;default:if(f.brandNo==="XB01"){e.packingQty.setReadOnly(true);e.packingType.setReadOnly(true);e.packingQty.setValue(1);e.packingType.setValue("B")}else{e.packingQty.setReadOnly(false)}e.boxQty.setReadOnly(true);e.sizeQty.setValue(g);d=e.sizeQty.getValue();b=e.packingQty.getValue();if(b<=0){e.boxQty.setValue(0);return}f.form.isValid();if(d%b>0){e.packingQty.selectText();e.boxQty.setValue(0);return}if(f.brandNo==="XB01"){e.boxQty.setValue(1)}else{e.boxQty.setValue(d/b)}break}},_createGrid:function(){var c=this,b,a;initData=Belle.clone(c.initData);a=new Ext.data.Store({fields:["sizeName","sizeNo",{name:"qty",type:"number"},{name:"seqNo",type:"number"},"sizeTypeNo"],proxy:{type:"ajax",url:c.getSizeUrl,reader:{type:"json",rootProperty:"list"},autoLoad:false}});b=new Ext.create("Ext.grid.Panel",{style:"margin:5px 0px 0px 0px;",columnWidth:1,columnLines:true,height:200,columns:[{header:"尺码",dataIndex:"sizeNo",width:100},{header:"数量",dataIndex:"qty",width:100,value:0,editor:{xtype:"numberfield",minValue:0}}],plugins:[{ptype:"cellediting",clicksToEdit:1}],store:a});a.loadData(initData.list);c.ATTRS.grids.gridForm=b;return b},_createForm:function(){var e=this,d,c=e._createGrid(),a=Belle.clone(e.initData);d=new Ext.form.Panel({timeout:"120",border:false,trackResetOnLoad:true,width:600,defaults:{style:"margin:5px 5px 0px 5px;",columnWidth:0.5,labelWidth:80},layout:"column",items:[{itemId:"materialNo",name:"materialNo",xtype:"materialfield",reference:"materialNo",fieldLabel:"产品编号",brandNo:e.brandNo,billNo:e.billNo,afterCall:function(l,k,g){if(Ext.isEmpty(k)){Belle.alert("返回数据异常");return}var f=e.ATTRS.fields;f.materialCode.setValue(k.materialCode);f.materialName.setValue(k.materialName);f.materialNo.setValue(k.materialNo);e._getPrice(k.materialNo,e.customerNo,k.textures,k.categoryNo,function(n,m){f.unitPrice.setValue(n);f.salePriceType.setValue(m)});var h=e.gridForm.getStore(),i=h.getProxy(),j=l.getValue();if(Ext.isEmpty(j)){h.removeAll();f.unitPrice.setValue("");f.materialName.setValue("");f.materialCode.setValue("");return}i.extraParams.materialNo=j;h.loadPage(1)},allowBlank:false,readOnly:e.winType==="update"},{itemId:"materialCode",name:"materialCode",xtype:"textfield",reference:"materialCode",fieldLabel:"产品ID",readOnly:true,allowBlank:false},{itemId:"materialName",name:"materialName",xtype:"textfield",reference:"materialName",fieldLabel:"产品名称",readOnly:true,allowBlank:false},{itemId:"unitPrice",name:"unitPrice",xtype:"numberfield",reference:"unitPrice",fieldLabel:"单价",readOnly:true,allowBlank:false,minValue:0},{itemId:"sizeQty",name:"sizeQty",xtype:"numberfield",reference:"sizeQty",fieldLabel:"数量",readOnly:true,allowBlank:false,minValue:0,validator:function(f){if(f<=0){return"数量不能小于1"}else{return true}}},{itemId:"boxQty",name:"boxQty",xtype:"numberfield",reference:"boxQty",fieldLabel:"箱数",readOnly:true,allowBlank:false,minValue:0,validator:function(f){if(f<=0){return"箱数不能小于1"}else{return true}}},{itemId:"packingQty",name:"packingQty",xtype:"numberfield",reference:"packingQty",fieldLabel:"装箱对数",allowBlank:false,minValue:0,validator:function(j){if(j<=0){return"装箱对数不能小于1"}var f=e.ATTRS.fields,i=f.packingType.getValue(),h=f.sizeQty.getValue(),g=f.packingQty.getValue();if(i!="C"){if(g<=0){return true}if(h%g>0){return"请检查装箱对数，不允许非整箱订货"}else{return true}}else{return true}}},{name:"packingType",itemId:"packingType",xtype:"combo",reference:"packingType",fieldLabel:"装箱方式",allowBlank:false,store:new Belle_Common.store.CmnDict({dictCode:"packing_type",module:e.module}),valueField:"itemCode",displayField:"itemName"},{name:"pointNo",itemId:"pointNo",xtype:"deliverypointfield",reference:"pointNo",fieldLabel:"收货地点",allowBlank:false,regionNo:e.regionNo,afterCall:function(h,g,f){h.setValue(g.pointNo);e.ATTRS.fields.pointName.setValue(g.pointName)}},{name:"pointName",itemId:"pointName",xtype:"textfield",reference:"pointName",fieldLabel:"收货地点名称",readOnly:true},{name:"sizeTypeNo",itemId:"sizeTypeNo",xtype:"textfield",reference:"sizeTypeNo",fieldLabel:"尺码类型",readOnly:true,hidden:true},{name:"salePriceType",itemId:"salePriceType",xtype:"textfield",reference:"salePriceType",fieldLabel:"价格类型",readOnly:true,hidden:true},c],dockedItems:[{xtype:"toolbar",dock:"top",items:[{itemId:e.id+"_BtnSave",text:"保存",glyph:Belle.Icon.btnSave},{itemId:e.id+"_BtnReduction",text:"还原",glyph:Belle.Icon.btnUndo},{itemId:e.id+"_BtnSaveAndClose",text:"保存并退出",glyph:Belle.Icon.btnSave},{itemId:e.id+"_BtnClose",text:"退出",glyph:Belle.Icon.btnCancel}]}]});e.ATTRS.btns.btnSave=d.down("[itemId="+e.id+"_BtnSave]");e.ATTRS.btns.btnReduction=d.down("[itemId="+e.id+"_BtnReduction]");e.ATTRS.btns.btnSaveAndClose=d.down("[itemId="+e.id+"_BtnSaveAndClose]");e.ATTRS.btns.btnClose=d.down("[itemId="+e.id+"_BtnClose]");e.ATTRS.fields.materialNo=d.down("[itemId=materialNo]");e.ATTRS.fields.unitPrice=d.down("[itemId=unitPrice]");e.ATTRS.fields.materialName=d.down("[itemId=materialName]");e.ATTRS.fields.materialCode=d.down("[itemId=materialCode]");e.ATTRS.fields.sizeQty=d.down("[itemId=sizeQty]");e.ATTRS.fields.boxQty=d.down("[itemId=boxQty]");e.ATTRS.fields.pointName=d.down("[itemId=pointName]");e.ATTRS.fields.pointNo=d.down("[itemId=pointNo]");e.ATTRS.fields.sizeTypeNo=d.down("[itemId=sizeTypeNo]");e.ATTRS.fields.packingQty=d.down("[itemId=packingQty]");e.ATTRS.fields.packingType=d.down("[itemId=packingType]");e.ATTRS.fields.salePriceType=d.down("[itemId=salePriceType]");if(e.brandNo==="XB01"){e.ATTRS.fields.packingQty.setReadOnly(true);e.ATTRS.fields.packingType.setReadOnly(true)}var b=new Ext.data.Store({fields:["materialNo","materialCode","materialName","sizeQty","boxQty"],data:a.body});d.loadRecord(b.getAt(0));e.gridForm=c;e.form=d;return d},_getPrice:function(b,e,a,d,f){var c=this;Ext.Ajax.request({url:c.getPrice,params:{materialNo:b,customerNo:e,priceType:3,textures:a,categoryNo:d},success:function(g){var j=Ext.decode(g.responseText),i=0,h="";if(!Ext.isEmpty(j)&&!Ext.isEmpty(j.Price)&&!Ext.isEmpty(j.Price.unitPrice)){i=j.Price.unitPrice;h=j.Price.priceType}if(typeof f==="function"){f(i,h)}},failure:function(g,h){if(typeof f==="function"){f(price,salePriceType)}Ext.MessageBox.show({title:"错误提示",msg:g.responseText,height:300,width:400})}})},_initTooblrStatus:function(){var c=this,a=c.gridForm,b=c.ATTRS.btns,d=a.isUpdate||c.form.isUpdate;b.btnSave.setDisabled(!d);b.btnSaveAndClose.setDisabled(!d);b.btnReduction.setDisabled(!d)},_initGridDataChangeStatus:function(){var c=this,b=c.gridForm,a=b.getStore(),d=false;Ext.each(a.data.items,function(e){if(e.dirty){d=true;return false}});b.isUpdate=d;return d},_reduction:function(){var c=this,d=Belle.clone(c.initData),a=c.ATTRS.fields,b=c.gridForm.getStore();if(c.winType=="add"){b.removeAll();c.form.reset(true)}else{b.loadData(d.list);a.materialCode.setValue(d.body.materialCode);a.materialName.setValue(d.body.materialName);a.materialNo.setValue(d.body.materialNo);a.packingType.setValue(d.body.packingType);if(d.body.packingType==="C"){a.sizeQty.setValue(d.body.sizeQty);a.boxQty.setValue(d.body.boxQty);a.packingQty.setValue(d.body.packingQty)}else{a.boxQty.setValue(d.body.boxQty);a.packingQty.setValue(d.body.packingQty);a.sizeQty.setValue(d.body.sizeQty)}a.pointNo.setValue(d.body.pointNo);a.pointName.setValue(d.body.pointName);a.unitPrice.setValue(d.body.unitPrice);c.form.getForm().setValues(d.body)}},_saveAndClose:function(){var a=this;a._callSave(function(b){if(b){a.mastergrid.getStore().load();a.grid1.getStore().load();a.isCanClose=true;a.close()}})},_callSave:function(j){var g=this,c=g.form,a=g.gridForm,h=a.getStore(),d=Belle.clone(g.initData),e=[],i=c.getValues(),b=(g.winType=="update"?g.updateUrl:g.saveUrl),k=[],f;if(!c.isValid()){return}Ext.each(h.data.items,function(m,l){var n=m.data.qty;if(n>0){if(i.packingType==="C"){e.push({qty:n*i.boxQty,sizeQty:n*i.boxQty,sizeNo:m.data.sizeNo})}else{e.push({qty:n,sizeQty:n,sizeNo:m.data.sizeNo})}}f=m.data.sizeTypeNo;k.push(Belle.clone(m.data))});d.body.billNo=g.billNo;Ext.apply(d.body,i);delete d.body.lineId;d.body.sizeTypeNo=i.sizeTypeNo||f;d.body.divisionNo=g.divisionNo;d.list=e;g.form.mask("数据提交中...");Ext.Ajax.request({method:"POST",url:b,params:{body:Ext.encode(d.body),list:Ext.encode(d.list)},success:function(l){var m=Ext.decode(l.responseText);g.form.unmask();if(m.result.resultCode=="0"){if(g.winType==="update"){g.initData.body=Belle.clone(d.body);g.initData.body.materialName=i.materialName;g.initData.body.pointName=i.pointName;g.initData.list=k}}else{Belle.alert(m.result.msg)}if(typeof j==="function"){j(m.result.resultCode=="0")}},failure:function(l,m){g.form.unmask();Ext.MessageBox.show({title:"错误提示",msg:l.responseText,height:300,width:400});if(typeof j==="function"){j()}}})},_save:function(){var a=this;a._callSave(function(b){if(b){a._reduction();a.mastergrid.getStore().load();a.grid1.getStore().load()}})},_canel:function(){var c=this,a=c.gridForm,b=c.form;c.close()}});
Ext.define("Belle_Common.ux.ComboCustom",{extend:"Ext.form.field.ComboBox",alias:"widget.extcombox",queryMode:"local",displayField:null,displaymember:null,valueField:null,valuemember:null,store:null,displayvalue:null,emptyText:"请选择",forceSelection:true,autoLoad:true,initComponent:function(){var e=this;var d=[];var a=null;if(e.store==null){if(e.valuemember==null){e.valueField="num";e.displayField="name";var j=e.displayvalue.split(":");for(var c=0;c<j.length;c++){var h=j[c].split("=");var b={};var g=h[0];var f=h[1];b.num=g;b.name=f;d.push(b)}a=Ext.create("Ext.data.Store",{fields:[e.valueField,e.displayField],data:d})}else{e.valueField=e.valuemember;e.displayField=e.displaymember;a=Ext.create("Belle_Common.store.Base",{fields:[e.valueField,e.displayField,"enableFlag"],proxy:{url:Belle.setUrlModuleInfo(e,e.displayvalue)},remoteSort:false,remoteFilter:false})}if(e.autoLoad){a.reload()}e.store=a}else{e.valueField=e.valuemember;e.displayField=e.displaymember}e.callParent()}});
Ext.define("Belle_Common.ux.ComboUseFlag",{extend:"Ext.form.field.ComboBox",alias:"widget.combouseflag",store:[["",""],[1,"启用"],[0,"禁用"]],editable:false,initComponent:function(){this.callParent()}});
Ext.define("Belle_Common.ux.ComboYesNo",{extend:"Ext.form.field.ComboBox",alias:"widget.comboyesno",store:[["",""],[1,"是"],[0,"否"]],editable:false,initComponent:function(){this.callParent()}});
Ext.define("Belle_Common.ux.CustomerField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.customerfield",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{dataIndex:"customerNo",text:"客户编号",flex:0.5},{dataIndex:"customerName",text:"客户名称",flex:0.5}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"customerNo",fieldLabel:"客户编号"},{name:"customerName",fieldLabel:"客户名称"}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_customer/list.json"}if(!Ext.isEmpty(a.otherGridColumns)){a.gridColumns=a.gridColumns.concat(a.otherGridColumns)}if(!Ext.isEmpty(a.otherSearchItems)){a.searchItems=a.searchItems.concat(a.otherSearchItems)}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"客户选择器"});
Ext.define("Belle_Common.ux.DateTimeField",{extend:"Ext.form.field.Date",alias:"widget.bldatetime",readOnly:false,contype:"date",initComponent:function(){this.format=this.format;this.afterMethod("afterRender",function(){this.getEl().applyStyles("top:0")});this.callParent()},createPicker:function(){var a=this,b=Ext.String.format;if(this.contype=="datetime"){if(this.format=="Y-m-d"||this.format==null){this.format="Y-m-d H:i:s"}return new Belle_Common.ux.DateTimePicker({pickerField:a,ownerCt:a.ownerCt,floating:true,focusable:true,hidden:true,minDate:a.minValue,maxDate:a.maxValue,disabledDatesRE:a.disabledDatesRE,disabledDatesText:a.disabledDatesText,disabledDays:a.disabledDays,disabledDaysText:a.disabledDaysText,format:a.format,showToday:a.showToday,startDay:a.startDay,minText:b(a.minText,a.formatDate(a.minValue)),maxText:b(a.maxText,a.formatDate(a.maxValue)),listeners:{scope:a,select:a.onSelect},keyNavConfig:{esc:function(){a.collapse()}}})}else{if(this.contype=="date"){if(this.format==null){this.format="Y-m-d"}return new Ext.picker.Date({pickerField:a,ownerCt:a.ownerCt,floating:true,focusable:true,hidden:true,minDate:a.minValue,maxDate:a.maxValue,disabledDatesRE:a.disabledDatesRE,disabledDatesText:a.disabledDatesText,disabledDays:a.disabledDays,disabledDaysText:a.disabledDaysText,format:a.format,showToday:a.showToday,startDay:a.startDay,minText:b(a.minText,a.formatDate(a.minValue)),maxText:b(a.maxText,a.formatDate(a.maxValue)),listeners:{scope:a,select:a.onSelect},keyNavConfig:{esc:function(){a.collapse()}}})}}}});Ext.define("Belle_Common.ux.DateTimePicker",{extend:"Ext.picker.Date",alias:"widget.datetimepicker",todayText:"确认",timeLabel:"时间",anchor:"100%",onRender:function(b,a){var d=this;if(!this.h){this.h=Ext.create("Ext.form.field.Number",{fieldLabel:this.timeLabel,labelWidth:40,value:this.value.getHours(),minValue:0,maxValue:23,style:"float:left",width:90,baseCls:"inputh",selectOnFocus:true});this.m=Ext.create("Ext.form.field.Number",{value:this.value.getMinutes(),minValue:0,maxValue:59,style:"float:left",inputType:"text",width:40,baseCls:"inputm",selectOnFocus:true});this.s=Ext.create("Ext.form.field.Number",{value:this.value.getSeconds(),minValue:0,maxValue:59,style:"float:left",inputType:"text",width:40,baseCls:"inputs",selectOnFocus:true})}this.h.ownerCt=this;this.m.ownerCt=this;this.s.ownerCt=this;this.h.on("change",this.htimeChange,this);this.m.on("change",this.mtimeChange,this);this.s.on("change",this.stimeChange,this);d.callParent(arguments);d.todayBtn.tooltip="";var c=Ext.get(Ext.DomQuery.selectNode("table",this.el.dom));var e=Ext.core.DomHelper.insertAfter(c.last(),{tag:"tr",style:"border:0px;",children:[{tag:"td",colspan:"7",cls:"x-datepicker-footer ux-timefield"}]},true);this.h.render(this.el.child("div tr td.ux-timefield"));this.m.render(this.el.child("div tr td.ux-timefield"));this.s.render(this.el.child("div tr td.ux-timefield"));this.ht=Ext.get(Ext.DomQuery.selectNode("div.inputh input",this.el.dom));this.ht.on("click",this.htclick,this);this.mt=Ext.get(Ext.DomQuery.selectNode("div.inputm input",this.el.dom));this.mt.on("click",this.mtclick,this);this.st=Ext.get(Ext.DomQuery.selectNode("div.inputs input",this.el.dom));this.st.on("click",this.stclick,this)},htclick:function(){this.ht.focus()},mtclick:function(){this.mt.focus()},stclick:function(){this.st.focus()},handleDateClick:function(d,a){var c=this,b=c.handler;d.stopEvent();if(!c.disabled&&a.dateValue&&!Ext.fly(a.parentNode).hasCls(c.disabledCellCls)){c.setValue(this.fillDateTime(new Date(a.dateValue)));if(b){b.call(c.scope||c,c,c.value)}c.onSelect()}},setValue:function(a){this.value=a;this.changeTimeFiledValue(a);return this.update(Ext.Date.clearTime(this.value||new Date(),true))},changeTimeFiledValue:function(a){this.h.un("change",this.htimeChange,this);this.m.un("change",this.mtimeChange,this);this.s.un("change",this.stimeChange,this);this.h.setValue(a.getHours());this.m.setValue(a.getMinutes());this.s.setValue(a.getSeconds());this.h.on("change",this.htimeChange,this);this.m.on("change",this.mtimeChange,this);this.s.on("change",this.stimeChange,this)},htimeChange:function(c,b,a){this.value=this.fillDateTime(this.value)},mtimeChange:function(c,b,a){this.value=this.fillDateTime(this.value)},stimeChange:function(c,b,a){this.value=this.fillDateTime(this.value)},fillDateTime:function(d){if(this.h){var c=this.h.value;var a=this.m.value;var b=this.s.value;d.setHours(c);d.setMinutes(a);d.setSeconds(b)}return d},getValue:function(){return this.fillDateTime(this.value)},selectToday:function(){var c=this,a=c.todayBtn,b=c.handler;if(a&&!a.disabled){c.setValue(this.fillDateTime(new Date(c.activeDate)));c.fireEvent("select",c,c.value);if(b){b.call(c.scope||c,c,c.value)}c.onSelect()}return c}});
Ext.define("Belle_Common.ux.DeliveryPointField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.deliverypointfield",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{header:"收货地点编号",dataIndex:"pointNo"},{header:"收货地点名称",dataIndex:"pointName"},{header:"收货地址",dataIndex:"contactAddress"},{header:"联系人",dataIndex:"contacter"},{header:"联系电话",dataIndex:"mobileNo"}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"pointNo",fieldLabel:"收货地点编号"},{name:"pointName",fieldLabel:"收货地点名称"},{name:"contactAddress",fieldLabel:"收货地址"},{name:"contacter",fieldLabel:"联系人"},{name:"mobileNo",fieldLabel:"联系电话"}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_delivery_point/listAll.json"}if(Ext.isEmpty(a.otherParams)){a.otherParams={regionNo:a.regionNo}}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"地址选择器",regionNo:""});
Ext.define("Belle_Common.ux.DropdownList",{extend:"Ext.form.field.ComboBox",alias:"widget.ddlfield",queryMode:"local",displayField:"textField",valueField:"idField",localData:null,url:"",fromFields:"",async:true,getFilters:function(){var e=this,g=[];if(!e.fromFields){return g}var a=e.fromFields.split(","),c=e.up().context,f,d=e.up("form");if(c||d){var b=c&&c.record||d.getRecord();Ext.each(a,function(i){if(b){f=b.get(i)}if(!f&&!d){var h=Belle.getField(d,i);if(h){f=h.getValue()}}g.push({property:i,value:f||"",operator:10})})}return g},afterLoad:function(){},reload:function(){var b=this;b.store.removeAll();if(b.localData){b.store.loadData(b.localData);b.afterLoad()}else{if(b.url){b.url=Belle.setUrlModuleInfo(b,b.url);var c=b.getFilters(),a={url:b.url,method:"POST",async:b.async,success:function(g){try{g=JSON.parse(g.responseText);if(g.list){b.store.loadData(g.list)}else{b.store.loadData(g)}b.afterLoad()}catch(f){Belle.alert("无法加载【"+b.fieldLabel+"】,服务端返回无效数据")}},failure:function(){Belle.alert("无法加载【"+b.fieldLabel+"】,请求服务器出错")}};if(!Ext.isEmpty(c)){a.params={queryCondition:JSON.stringify(c)}}Belle.callServer(a)}}},initComponent:function(){var a=this;if(!a.store){a.store=Ext.create("Ext.data.JsonStore",{fields:[a.displayField,a.valueField,"enableFlag"]});a.reload()}a.callParent(arguments)}});
var Belle=Belle||{};Belle.getField=function(a,b){if(!a){return null}return a.getForm().getFields().findBy(function(c){return c.name==b})};Belle.alert=function(e,b,a){var d="系统提示",c=Ext.Msg.alert(d,e,b,a);return c};Belle.confirm=function(d,b,a){var c="系统提示";return Ext.Msg.confirm(c,d,b,a)};Belle.show=function(a){return Ext.Msg.show(a)};Belle.clone=function(c){var a;if(Ext.isArray(c)){a=[]}else{if(Ext.isObject(c)){a={}}else{return c}}for(var b in c){var d=c[b];if((Ext.isObject(d)&&d.constructor.name=="Object")||Ext.isArray(d)){a[b]=arguments.callee(d)}else{a[b]=c[b]}}return a};Belle.openUrl=function(b,d,a,c){d=d||"弹出窗口";a=a||1024;c=c||500;if(b.indexOf("?")>0){b+="&_dc="}else{b+="?_dc="}b+=new Date().getTime();return Ext.widget("window",{closeAction:"destroy",modal:true,width:a,height:c,title:d,html:'<iframe frameborder=0 width="100%" height="100%" src="'+b+'"></iframe>',autoShow:true})};Belle.callServer=function(a){if(a.url.indexOf("noFilterData=")<0){a.url+=(a.url.indexOf("?")>0?"&":"?")+"noFilterData=TRUE"}Ext.Ajax.request(a)};Belle.setUrlModuleInfo=function(a,b){if(!b){return""}if(b.indexOf("sys_menu_moduleUrl=")>0){return b}b+=(b.indexOf("?")>0?"&":"?");var c=a;if(!a){return b+"sys_menu_moduleUrl=/blf1-uc-web/main&sys_menu_moduleId=-110"}if(!a.is("basepage")){c=a.up("basepage")}if(!c){c=a.scope}if(!c){return b+"sys_menu_moduleUrl=/blf1-uc-web/main&sys_menu_moduleId=-110"}b+="sys_menu_moduleUrl="+c.moduleUrl.replace(/#/g,"")+"&sys_menu_moduleId="+c.moduleId;return b};function fillzeno(a){return a<10?"0"+a:a}Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getFullYear()+"-"+fillzeno(this.getMonth()+1)+"-"+fillzeno(this.getDate())+" "+fillzeno(this.getHours())+":"+fillzeno(this.getMinutes())+":"+fillzeno(this.getSeconds()):null};Ext.onReady(function(){Ext.Ajax.timeout=180000;Ext.apply(Ext.form.VTypes,{compareTo:function(e,d){this.compareToText=d.compareError||"两次输入的值不一致";var c=d.up("form");var a=d.compareType||"=";if(d.compareTo&&c){var b=c.getValues()[d.compareTo];if(a==">"){return(e>b)}else{if(a==">="){return(e>=b)}else{if(a=="<"){return(e<b)}else{if(a=="<="){return(e<=b)}else{return(e==b)}}}}}return true}})});Array.prototype.belleCopy=function(){var c=[];if(this.length<=0){return c}for(var b=0;b<this.length;b++){var a=new Object();a[b]=this[b];c.push(a[b])}return c};Array.prototype.maxValue=function(e){if(e){var c=[];for(var d=0;d<this.length;d++){var f=e.split("."),g=this[d],a=false;for(var b=0;b<f.length;b++){g=g[f[b]];if(!g){a=false;return false}a=true}if(a){c.push(g)}}return Math.max.apply({},c)}else{return Math.max.apply({},this)}};Array.prototype.minValue=function(e){if(e){var c=[];for(var d=0;d<this.length;d++){var f=e.split("."),g=this[d],a=false;for(var b=0;b<f.length;b++){g=g[f[b]];if(!g){a=false;return false}a=true}if(a){c.push(g)}}return Math.min.apply({},c)}else{return Math.min.apply({},this)}};Belle.minValue=function(a){return Math.min.apply(Math,a)};Belle.maxValue=function(a){return Math.max.apply(Math,a)};Belle.EventStop=function(a){a.returnValue=false;if(a.preventDefault){a.preventDefault()}if(!a.stopPropagation){a.cancelBubble=true}else{a.stopPropagation()}};Belle.ctrlKey13=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnSearch&&!a.btnSearch.isDisabled()&&a.btnSearch.isVisible()){a.btnSearch.btnEl.dom.click()}}};Belle.ctrlKey45=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnAdd&&!a.btnAdd.isDisabled()&&a.btnAdd.isVisible()){a.btnAdd.btnEl.dom.click()}}};Belle.ctrlKey46=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnDelete&&!a.btnDelete.isDisabled()&&a.btnDelete.isVisible()){a.btnDelete.btnEl.dom.click()}}};Belle.keyCode8=function(b,a){if(!b||!b.target){return true}if(b.target.value==window.undefined||b.target.readOnly||b.target.disabled){b.keyCode=505;return false}return true};Belle.ctrlKey83=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnSave&&!a.btnSave.isDisabled()&&a.btnSave.isVisible()){a.btnSave.btnEl.dom.click()}if(a&&a.btnBillSave&&!a.btnBillSave.isDisabled()&&a.btnBillSave.isVisible()){a.btnBillSave.btnEl.dom.click()}}};Belle.ctrlKey69=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnEdit&&!a.btnEdit.isDisabled()&&a.btnEdit.isVisible()){a.btnEdit.btnEl.dom.click()}}};Belle.ctrlKey82=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnReset&&!a.btnReset.isDisabled()&&a.btnReset.isVisible()){a.btnReset.btnEl.dom.click()}}};Belle.ctrlKey85=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnUndo&&!a.btnUndo.isDisabled()&&a.btnUndo.isVisible()){a.btnUndo.btnEl.dom.click()}}};Belle.altKey67=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnUndo&&!a.btnUndo.isDisabled()&&a.btnCancel.isVisible()){a.btnCancel.btnEl.dom.click()}}};Belle.ctrlKey68=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnBillDel&&!a.btnBillDel.isDisabled()&&a.btnBillDel.isVisible()){a.btnBillDel.btnEl.dom.click()}}};Belle.ctrlKey38=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnBillPrev&&!a.btnBillPrev.isDisabled()&&a.btnBillPrev.isVisible()){a.btnBillPrev.btnEl.dom.click()}}};Belle.ctrlKey40=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnBillNext&&!a.btnBillNext.isDisabled()&&a.btnBillNext.isVisible()){a.btnBillNext.btnEl.dom.click()}}};Belle.ctrlKey73=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnBillNew&&!a.btnBillNew.isDisabled()&&a.btnBillNew.isVisible()){a.btnBillNew.btnEl.dom.click()}}};Belle.ctrlKey66=function(c,b){if(b&&b.controller){var a=b.controller.getObjList();if(a&&a.btnBillBack&&!a.btnBillBack.isDisabled()&&a.btnBillBack.isVisible()){a.btnBillBack.btnEl.dom.click()}}};Ext.onReady(function(){Ext.tip.QuickTipManager.init();window.document.onkeydown=function(g){var k="";if(g.shiftKey){k="shiftkey"}if(g.ctrlKey){k+="ctrlKey"}if(g.altKey){k+="altKey"}if(Ext.isEmpty(k)){k+="keyCode"+g.keyCode}else{k+=g.keyCode}if(Belle.moduleWidget()){if(k==="keyCode8"){return Belle.keyCode8(g,null)}var f=false,b=Ext.getBody().component;if(!b.controller){return}var i=b.controller.getObj("selftab");if(i){var l=i.getActiveTab();if(l&&l.xtype===b.dtlName){b=l}}if(typeof b.controller.onPageKeyDown=="function"){f=b.controller.onPageKeyDown(b,g)}if(f===true){Belle.EventStop(g);return false}if(f!=true&&typeof Belle[k]=="function"){Belle.EventStop(g);Belle[k](g,b);return false}return true}if(window.main&&window.main.selectPanel){var b=Ext.clone(window.main.selectPanel),h=b.up()?b.up():b,f=false,d=window.main.tabPanel,j=d.getActiveTab(),i,l,c=h.is("window");if(c){if(h.isHidden&&h.isHidden()){b=j}}else{if(!b.controller){b=j}}if(!b.controller){return}i=b.controller.getObj("selftab");if(i){l=i.getActiveTab()}if(l&&l.xtype===b.dtlName){b=l}if(b.controller&&typeof b.controller.onPageKeyDown=="function"){f=b.controller.onPageKeyDown(b,g)}if(f===true){Belle.EventStop(g);return false}if(f!=true&&typeof Belle[k]=="function"){if(k==="keyCode8"){return Belle.keyCode8(g,null)}Belle.EventStop(g);Belle[k](g,b);return false}else{return true}}else{if(k==="keyCode8"){return Belle.keyCode8(g,null)}else{return true}}};var a=Belle.jq();if(a){a(".index-loadpage").hide()}});Belle.getUserModule=function(a,b){var c;Ext.each(b,function(d){if(d.data.moduleNo&&d.data.moduleNo.toString()===a){c=d.data;return false}if(d.childNodes&&d.childNodes.length>0){c=Belle.getUserModule(a,d.childNodes);if(c){return false}}});return c};Belle.loadAppJs=function(b,h,c){var f=b,d=h,i=d.url.split("#"),g=d.appCode.toLowerCase(),e=i[0]+d.jsUrl;var a=g+"IsLoaded";d.title=d.text;if(g!="uc"&&!Belle[a]){var b=f;if(b&&b.mask){b.mask("加载应用Js文件中,请稍后...")}Ext.Loader.loadScript({url:e,onLoad:function(){if(b&&b.unmask){b.unmask()}Belle[a]=true;if(Belle.checkModule(i[1])===false){return}if(typeof(c)==="function"){c(d)}},onError:function(){if(b&&b.unmask){b.unmask()}Belle.alert("加载应用的Js文件出错")}})}else{if(Belle.checkModule(i[1])===false){return}if(typeof(c)==="function"){c(d)}}};Belle.checkModule=function(b){var a=Ext.ClassManager.getNameByAlias("widget."+b);if(a){return true}Belle.alert("URL出错,无法创建此模块");return false};Belle.getPageView=function(a,b,c){var a=a;if(a&&a.mask){a.mask("加载应用Js文件中,请稍后...")}Belle.callServer({url:"/uc_layout_v1/getLayout.json?sys_menu_moduleId="+b.moduleNo+"&resCode="+b.moduleId,params:{resCode:b.moduleId},success:function(d,e){var f=Ext.decode(d.responseText);if(a&&a.mask){a.unmask()}c(f.list)},failure:function(d,e){if(a&&a.mask){a.unmask()}c(null)}})};Belle.createModule=function(a,f,h){var d;if(!a){Belle.alert("请设置模块信息");return}var e=a.userModule,i=a.userInfo,b=a.params||{},c=a.xtype,g;if(Ext.isEmpty(e)){Belle.alert("请设置模块权限信息");return}if(Ext.isEmpty(i)){Belle.alert("请设置用户限信息");return}Belle.getPageView(f,{userCode:i.userCode,moduleId:e.url.split("#")[1],moduleUrl:e.url.replace("#",""),moduleNo:e.moduleNo},function(o){g={userGridCols:o,xtype:e.url.split("#")[1],moduleUrl:e.url,moduleId:e.moduleNo,moduleName:e.moduleName,userRight:e.rights,moduleRight:e.rightValue,params:b||[],billNo:b.billNo||"",showType:"linkcolumn"};title=e.title+(b.billNo?"【"+b.billNo+"】":"");switch(c){case"window":var l={layout:"fit",width:800,height:600,resizable:false,title:title,constrain:true,closeAction:"destroy",autoShow:true,items:[g],params:b||[],billNo:b.billNo||"",showType:"linkcolumn"};Ext.applyIf(a.option,l);d=Ext.widget("window",a.option);break;default:var p=Ext.getCmp("maintabpanel"),n=e.url.split("#")[1],k="tab_"+e.moduleNo+e.menuName,j;if(!Ext.isEmpty(b.billNo)){k+=b.billNo.replace(/\,/g,"")}j=p.getComponent(k);if(!j){var m={userGridCols:o,title:title,itemId:k,xtype:n,moduleUrl:e.url,moduleId:e.moduleNo,moduleName:e.moduleName,userRight:e.rights,moduleRight:e.rightValue,closable:true,reorderable:true,loadMask:"加载中...",params:b||{},billNo:b.billNo||"",showType:"linkcolumn"};Ext.applyIf(a.option,m);j=p.add(m)}p.setActiveTab(j);panel=p.getActiveTab();if(panel&&panel.controller&&typeof(panel.controller.getObjList)=="function"){objList=panel.controller.getObjList();if(objList&&objList.commonsearch){form=objList.commonsearch.getForm();form.setValues(b)}if(objList&&objList.btnSearch&&!objList.btnSearch.isDisabled()&&objList.btnSearch.isVisible()){objList.btnSearch.btnEl.dom.click()}}d=p;break}if(typeof(h)=="function"){h(d)}})};Belle.openModel=function(c,e,b,d,a,f){if(Belle.moduleWidget()&&Belle.jq()&&e.billNo){Belle.openModelInV2(c,e.billNo);return}if(!a){a=Ext.getBody()}if(a.view){a=a.view}if(window.main&&window.main.leftTree){userInfo=window.main.userInfo||{};leftTree=window.main.leftTree;leftTreeStore=leftTree.store;data=Belle.getUserModule(c,leftTreeStore.data.items);if(!data){Belle.alert("您没有该模块权限！");return}if(!data.leaf||!data.url){return}Belle.loadAppJs(a,data,function(g){Belle.createModule({xtype:b,option:d,userInfo:userInfo,userModule:g,params:e},a,f)})}else{Belle.callServer({url:"/blf1-uc-web/itg_menu_list/getusermenulist.json?sys_menu_moduleUrl=/blf1-uc-web/main&sys_menu_moduleId=0&_dc=1440634535405&node=root",success:function(g){var j=Ext.decode(g.responseText),i;if(!j||!j.list||j.list.length<=0){Belle.alert("获取模块信息失败");return}var h=function(k,m){var l;Ext.each(m,function(n){if(n.moduleNo&&n.moduleNo.toString()===k){l=n;return false}});return l};i=h(c,j.list);if(!i){Belle.alert("您没有该模块权限！");return}userInfo={userCode:"admin"};Belle.loadAppJs(a,i,function(k){Belle.createModule({xtype:b,option:d,userInfo:userInfo,userModule:k,params:e},a,f)})},failure:function(g,h){a.unmask();Ext.MessageBox.show({title:"错误提示",msg:g.responseText,height:300,width:400})}})}};Belle.strEscape=function(a){return(a||"").replace(/\'/g,"").replace(/\"/g,"").replace(/\n/ig,"<br/>")};Belle.formatMoney=function(b,a){Ext.util.Format.number(b,a)};Belle.openInV2=function(){var c={};c.moduleId=Belle.moduleWidget();if(!c.moduleId){return}c.moduleNo=Belle.getUrlParam("sys_menu_moduleId");c.userCode=Belle.getUrlParam("u");var a=location.href.replace(location.origin,"").substr(1);if(a.indexOf("/")>0){a=a.substr(0,a.indexOf("/"))}c.moduleUrl="/"+a+"/"+Belle.moduleWidget();c.userRight=Belle.getUrlParam("ur");c.moduleRight=Belle.getUrlParam("mr");c.params={};c.params.billNo=Belle.getUrlParam("bno")||"";var d=Belle.jq(),b=d?d("#index_userInfo").text():"";c.userName=b;window.main=window.main||{};window.main.userInfo={userCode:c.userCode,userName:b};Belle.getPageView(null,c,function(f){try{Ext.widget(c.moduleId,{plugins:"viewport",moduleUrl:c.moduleUrl,moduleId:c.moduleNo,moduleName:c.moduleNo,userRight:c.userRight,moduleRight:c.moduleRight,userGridCols:f,userName:c.userName,userCode:c.userCode,params:c.params,showType:(c.params.billNo?"linkcolumn":""),billNo:c.params.billNo})}catch(g){Ext.Msg.alert("错误提示","访问的URL不正确")}})};Belle.jq=function(){var a=Belle.v2Win();if(a){return a.$}return null};Belle.getNodeInV2=function(a,b){var c=null;Ext.each(a,function(d){if(d.moduleCode==b){c=d;return false}if(!c&&d.hasChildren&&!Ext.isEmpty(d.children)){c=Belle.getNodeInV2(d.children,b)}});return c};Belle.openModelInV2=function(b,g){var e=Belle.v2Win();if(!e){Belle.alert("无法打开新模块,请在2.0主框架中进入");return}var d=e.app.index.$leftTree._data;var c=Belle.getNodeInV2(d,b);if(!c){Belle.alert("对不起，你没有权限打开对此进行操作");return}var a=c.url;a=Belle.setUrlParam(a,"mr",c.rightValue);a=Belle.setUrlParam(a,"ur",c.rights);a=Belle.setUrlParam(a,"u",Belle.getUrlParam("u"));a=Belle.setUrlParam(a,"bno",g);var f=c.oldText||c.text+"【"+g+"】";e.app.index.addTabItem(e.app.index.$tab,f,a)};Belle.initApp=function(){var b=Belle.v2Win();if(b){if(b.v1Loaded){return}b.v1Loaded=true}var e=["pd","sd","mdm","mm","pp","qm","cs","fa","report"],a=window.location.origin,c;for(var d=0;d<e.length;d++){c=a+"/blf1-"+e[d]+"-web/load_service.json?_dc="+new Date().getTime();Ext.Loader.loadScript({url:c})}};
Ext.grid.plugin.CellEditing.override({onSpecialKey:function(d,l,f){var g=this;var a;if(f.getKey()===f.TAB){f.stopEvent();if(l.is("searchhelpfield")&&l.needCall){l.sendToServer();return}if(d){d.onEditorTab(f)}g._newRow(d.editingPlugin,f);a=d.getRefOwner().getSelectionModel();return a.onEditorTab(d.editingPlugin,f)}else{if(f.keyCode>36&&f.keyCode<41){if(d.grid.inEditStatus){return}if(l.is("searchhelpfield")&&l.needCall){l.sendToServer();return}f.stopEvent();var h=d.editingPlugin,j=h.context.view,c=h.getActiveRecord(),b=h.context,k,i;if(f.keyCode==38){k="up"}else{if(f.keyCode==39){k="right"}else{if(f.keyCode==40){k="down"}else{k="left"}}}do{i=b;b=j.walkCells(b,k,f,g.preventWrap);if(i&&i.isEqual(b)){return}}while(b&&(!b.column.getEditor(c)||!h.startEditByPosition(b)))}else{if(f.getKey()===f.ENTER){if(l.is("searchhelpfield")&&l.needCall){f.stopEvent();l.sendToServer()}}}}},_newRow:function(l,h){var k=this,g=l.context,n=l.context.view,o=h.shiftKey?"left":"right",a=l.grid,p=a.getStore(),m=p.getCount(),b=a.headerCt.columnManager.columns,j=-1;if(a.isCandNewRow==false){return}for(var d=g.column.fullColumnIndex;d<b.length;d++){if(g.column!=b[d]&&b[d].getEditor()){j=d;break}}if(j>-1||g.rowIdx!=m-1){return}var f=n.store.model,c=f.create({_flag:"A"});p.add(c);a.getSelectionModel().select(m)}});Ext.view.View.override({handleEvent:function(d){var c=this,b=c.keyEventRe.test(d.type),a=c.getNavigationModel();d.view=c;if(b){d.item=a.getItem();d.record=a.getRecord()}if(!d.item){d.item=d.getTarget(c.itemSelector)}if(d.item&&!d.record){d.record=c.getRecord(d.item)}if(c.processUIEvent(d)!==false){c.processSpecialEvent(d)}}});Ext.grid.header.Container.override({privates:{onHeaderActivate:function(b){var a=this.getFocusableFromEvent(b);if(a&&a.bellefilterEl){if(a.sortable&&this.sortOnClick){a.toggleSortState()}this.onHeaderClick(a,b,a.el)}}}});Ext.form.field.Base.override({tabIndex:1,initComponent:function(){var a=this;a.callParent();a.subTplData=a.subTplData||{};a.initLabelable();a.initField();if(!a.name){a.name=a.getInputId()}if(a.readOnly){a.addCls(a.readOnlyCls)}a.addCls(Ext.baseCSSPrefix+"form-type-"+a.inputType);if(a.allowBlank===false){a.labelCls=Ext.baseCSSPrefix+"form-item-label notnull-field"}a.on("writeablechange",function(c,d){var b=a.oldTabIndex||a.getTabIndex()||1;if(d){if(Ext.isEmpty(a.oldTabIndex)){a.oldTabIndex=b}a.setTabIndex(-1)}else{a.setTabIndex(b)}});a.on("disabled",function(){var b=a.oldTabIndex||a.getTabIndex();if(Ext.isEmpty(a.oldTabIndex)){a.oldTabIndex=b}a.setTabIndex(-1)});a.on("enable",function(c){var b=a.oldTabIndex||a.getTabIndex();a.setTabIndex(b)});if(!a.plugins||!a.plugins.join){a.plugins=[]}},initEvents:function(){var b=this,a=b.labelEl,c=b.inputEl;b.callParent(arguments);if(a){if(b.isDbClickClearValue!=false){a.on("dblclick",function(f,d){if(b.readOnly||b.canInput==false||b.isDisabled()==true){return}b.setValue("")})}}if(c){c.on("dblclick",function(){if(b.up){var d=b.up("grid");if(d){d.inEditStatus=true}}})}}});Ext.data.field.Date.override({convert:function(c){if(!c){return null}if(c instanceof Date){return c}var a=this.dateReadFormat||this.dateFormat,b;if(a){return Ext.Date.parse(c,a)}if(typeof c=="string"){c=c.replace(/-/g,"/")}b=Date.parse(c);return b?new Date(b):null}});Ext.toolbar.Paging.override({updateBarInfo:function(){var a=this;if(!a.store.isLoading()&&a.store.autoLoad){a.calledInternal=true;a.onLoad();a.calledInternal=false}}});Ext.selection.CheckboxModel.override({privates:{selectWithEventMulti:function(a,d,b){var c=this;if(!d.shiftKey&&!d.ctrlKey&&d.getTarget(c.checkSelector)){if(b){c.doDeselect(a,false)}else{c.doSelect(a,true)}}else{c.callParent([a,d,b])}}}});Ext.override(Ext.grid.Panel,{initComponent:function(){var c=this,a=c.getPlugins(),b;if(a){a.push("belleheaderfilter")}else{a=["belleheaderfilter"]}c.plugins=a;if(!c.viewConfig){c.viewConfig={};c.viewConfig.plugins=[]}if(!c.viewConfig){c.viewConfig={}}if(!c.viewConfig.plugins||!c.viewConfig.plugins.join){c.viewConfig.plugins=[]}Ext.each(c.viewConfig.plugins,function(d){if(d.ptype=="celldragdrop"){b=true;return false}});c.callParent()},isFilter:false,isLocal:false});Ext.override(Ext.form.field.ComboBox,{initComponent:function(){var f=this,d=Ext.isDefined,c=f.store,e=f.transform,h=f.displayTpl,b,g;if(f.typeAhead&&f.multiSelect){Ext.Error.raise("typeAhead and multiSelect are mutually exclusive options -- please remove one of them.")}if(f.typeAhead&&!f.editable){Ext.Error.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}if(f.selectOnFocus&&!f.editable){Ext.Error.raise("If selectOnFocus is enabled the combo must be editable: true -- please change one of those settings.")}if("pinList" in f){f.collapseOnSelect=!f.pinList}if(e){b=Ext.getDom(e);if(b){if(!f.store){c=Ext.Array.map(Ext.Array.from(b.options),function(i){return[i.value,i.text]})}if(!f.name){f.name=b.name}if(!("value" in f)){f.value=b.value}}}f.bindStore(c||"ext-empty-store",true,true);if(!h){f.displayTpl=new Ext.XTemplate('<tpl for=".">{[typeof values === "string" ? values : values["'+f.displayField+'"]]}<tpl if="xindex < xcount">'+f.delimiter+"</tpl></tpl>")}else{if(!h.isTemplate){f.displayTpl=new Ext.XTemplate(h)}}g=f.queryMode==="local";if(!d(f.queryDelay)){f.queryDelay=g?10:500}if(!d(f.minChars)){f.minChars=g?0:4}f.callParent();f.doQueryTask=new Ext.util.DelayedTask(f.doRawQuery,f);if(b){if(f.transformInPlace){f.render(b.parentNode,b);delete f.renderTo}Ext.removeNode(b)}var a=f.multiSelect==true?'<div class="combo-multi"></div>':"";f.tpl=Ext.create("Ext.XTemplate",'<tpl for=".">',"{% ","enableFlag=values.enableFlag; ",'if (enableFlag == undefined||enableFlag==null||enableFlag==""||enableFlag==1){',"enableFlag=1;","}else{","enableFlag=0;","} ","%}",'<tpl if="enableFlag==1">','<div class="x-boundlist-item">'," "+a+"","{"+f.displayField+"}",f.groupField?"&nbsp(<span style='color:red;'>{count}</span>)":"","</div>","</tpl>",'<tpl else if="enableFlag==0">','<div class="x-boundlist-item x-boundlist-item-readonly" style="background-color: #EBEBE4;background-image: none;">'," "+a+"","{"+f.displayField+"}</div>","</tpl>","</tpl>")},afterRender:function(){var c=this;c.callParent(arguments);c.setHiddenValue(c.value);var a=c.getStore(),b=[];c.on("beforeselect",function(d,e){return e.get("enableFlag")!=0});a.on("load",function(d){b.push({property:"enableFlag",direction:"DESC"});a.remoteSort=false;a.remoteFilter=false;a.sort(b);a.oddData=a.getData().items.belleCopy()});c.on("beforequery",function(d){a=c.store;if(a.getCount()>0||(a.oddData&&a.oddData.length>0)){c._filter(d.query);return false}else{if(Ext.isEmpty(d.query)&&a.oddData&&a.oddData.length>0){c._filter("");return false}if(c.autoLoad==false&&!a.oddData){c.store.load({callback:function(f,e,g){if(g){c.expand()}}})}return true}});c.on("blur",function(){if(c.store&&c.store.oddData){c.store.loadData(c.store.oddData)}})},delimiter:",",_filter:function(f){var e=this,c=e.getStore(),a=-1,d=[],b=[];if(Ext.isEmpty(c.oddData)){c.oddData=c.getData().items.belleCopy();c.loadData(c.oddData)}if(Ext.isEmpty(f)){c.loadData(c.oddData||[]);e.expand();return}b=f.split(e.delimiter);if(!Ext.isEmpty(b)){f=b[b.length-1]}d=c.oddData.filter(function(g){index=g.data[e.displayField].toUpperCase().indexOf(f.toUpperCase());if(g.data[e.displayField].toUpperCase()===f.toUpperCase()){a=d.length}return index>=0});c.loadData(d);if(a>=0){e.setSelection(c.getAt(a))}e.expand()},isCanSelect:true});Ext.grid.column.Column.override({childEls:["titleEl","triggerEl","textEl","bellefilterEl"],headerTpl:['<div id="{id}-titleEl" data-ref="titleEl" {tipMarkup}class="',Ext.baseCSSPrefix,"column-header-inner",'<tpl if="empty"> ',Ext.baseCSSPrefix,'column-header-inner-empty</tpl>">','<span id="{id}-textEl" data-ref="textEl" class="',Ext.baseCSSPrefix,"column-header-text",'{childElCls}">',"{text}","</span>",'<tpl if="!menuDisabled">','<div id="{id}-triggerEl" data-ref="triggerEl" role="presentation" class="',Ext.baseCSSPrefix,"column-header-trigger",'{childElCls}" style="{triggerStyle}"></div>',"</tpl>","</div>",'<div id="{id}-bellefilterEl" data-ref="bellefilterEl" class="bellefilter-common-body" style="{belleBodyStyle}"></div>',"{%this.renderContainer(out,values)%}"],onTitleElClick:function(g,d){var f=this,b,c,a;if(Ext.supports.Touch){c=f.previousSibling(":not([hidden])");if(!f.menuDisabled&&f.isOnRightEdge(g,parseInt(f.triggerEl.getStyle("width")))){if(!f.menuDisabled){b=f}}else{if(c&&!c.menuDisabled&&f.isOnLeftEdge(g)){b=c}}}else{b=f.triggerEl&&(g.target===f.triggerEl.dom||d===f.triggerEl.dom||g.within(f.triggerEl))?f:null;a=f.bellefilterEl&&(g.target===f.bellefilterEl.dom||d===f.bellefilterEl.dom||g.within(f.bellefilterEl))?f:null}if(!a&&!b&&!f.isOnLeftEdge(g)&&!f.isOnRightEdge(g)||g.getKey()){f.toggleSortState()}return b},initComponent:function(){var c=this;c.rendererScope=c.initialConfig.scope;if(c.header!=null){c.text=c.header;c.header=null}if(c.cellWrap){c.tdCls=(c.tdCls||"")+" "+Ext.baseCSSPrefix+"wrap-cell"}if(c.columns!=null){c.isGroupHeader=true;if(c.dataIndex){Ext.Error.raise("Ext.grid.column.Column: Group header may not accept a dataIndex")}if((c.width&&c.width!==Ext.grid.header.Container.prototype.defaultWidth)||c.flex){Ext.Error.raise("Ext.grid.column.Column: Group header does not support setting explicit widths or flexs. The group header width is calculated by the sum of its children.")}c.items=c.columns;c.columns=c.flex=c.width=null;c.cls=(c.cls||"")+" "+c.groupHeaderCls;c.sortable=c.resizable=false;c.align="center"}else{if(c.flex){c.minWidth=c.minWidth||Ext.grid.plugin.HeaderResizer.prototype.minColWidth}}c.addCls(Ext.baseCSSPrefix+"column-header-align-"+c.align);var b=c._getGrid();if(!b.fieldDatas){b.fieldDatas={}}if(b&&!b.isReadOnly&&c.editor){if(c.editor.allowBlank===false){c.addCls("notnull-field")}else{c.addCls("cannull-field")}}c.renderTpl=c.headerTpl;var a=c.getChildEls();a.bellefilterEl={itemId:"bellefilterEl",name:"bellefilterEl"};c.setChildEls(a);c.on("afterrender",function(d){this.belleBodyStyle="height:30px;";c.createHeaderEl(this)});if(b){c.initGridMethods(b);if(!b.isAddEvent){c.initStoreEvents(b);b.isAddEvent=true}if(b.isFilter){b.removeCls("grid-filter-hide")}else{b.addCls("grid-filter-hide")}}c.setupRenderer();c.setupRenderer("edit");c.setupRenderer("summary");c.callParent(arguments)},initStoreEvents:function(b){var c=this;var a=b.getStore();a.on("load",function(){if(a.proxy&&a.proxy.reader&&a.proxy.reader.rawData&&a.proxy.reader.rawData.list){a.oddData=a.proxy.reader.rawData.list.belleCopy()}else{a.oddData=a.getData().items.belleCopy()}if(b.getFilterLocal()){c._filterLocal()}});a.on("beforeload",function(){})},initRenderData:function(){var b=this,e="",c=b.tooltip,d=b.text,a=b.tooltipType==="qtip"?"data-qtip":"title";if(!Ext.isEmpty(c)){e=a+'="'+c+'" '}return Ext.applyIf(b.callParent(arguments),{text:d,empty:d==="&#160;"||d===" "||d==="",menuDisabled:b.menuDisabled,tipMarkup:e,triggerStyle:this.getTriggerVisible()?"display:block":"",belleBodyStyle:b.belleBodyStyle})},createHeaderEl:function(d){var f=this,e=f._getGrid(),b;if(!d.dataIndex){return}var a=d.bellefilterEl;if(a&&!d.bellefilterObj){var c={width:"100%",renderTo:a.dom,listeners:{afterrender:function(g){if(e.fieldDatas[g.property]!=window.undefined){g.setValue(e.fieldDatas[g.property])}}}};if(!d.belleFilter){d.belleFilter={xtype:"bellefilter"}}else{if(!d.belleFilter.xtype){d.belleFilter.xtype="bellefilter"}}if(!d.belleFilter.filterType){d.belleFilter.filterType="like"}c.property=d.dataIndex;c.propertyName=d.belleFilter.dataIndex||d.dataIndex;switch(d.belleFilter.filterType){case"like":b="15";break;case"=":b="10";break;case">":b="11";break;case"<":b="12";case"likeleft":b="19";case"likeright":b="20";break;default:b="10";break}d.belleFilter.operator=b;d.belleFilter.hidden=d.belleFilter.isOpen==false?true:false;Ext.applyIf(c,d.belleFilter);d.bellefilterObj=Ext.widget(c);d.bellefilterObj.grid=e;d.bellefilterObj.inputEl.on("focus",function(g){var h=d.bellefilterObj.getValue();if(!Ext.isEmpty(h)){d.bellefilterObj.selectText(0,h.length)}return false});d.bellefilterObj.on("change",function(i,h,g){e.fieldDatas[i.property]=h});d.bellefilterObj.inputEl.on("dblclick",function(g){d.bellefilterObj.setValue("");return false});if(d.belleFilter.xtype==="bellefilter"){d.bellefilterObj.on("onSelectFilter",function(j,i,g,h){f._changeValueFilter()});d.bellefilterObj.on("onBelleFilterKeyup",function(l,i,g,h,j){var k=j.keyCode;f._keyFilter(k)});d.bellefilterObj.on("onBelleFilterChange",function(k,i,g,h,j){})}else{d.bellefilterObj.el.on("keyup",function(i,g){var h=g.keyCode;f._keyFilter(h)});d.bellefilterObj.on("change",function(i,h,g){f._changeValueFilter()})}}},_getGrid:function(){var c=this,a=c,b;while(!b&&a){a=a.up();if(a){b=a.grid}}return b},_keyFilter:function(d){var c=this,a=c._getGrid(),b;if(!a){return}b=a.getFilterLocal();if(!b){if(d!=13){return}c._filterServer()}else{c._filterLocal()}},_changeValueFilter:function(){var c=this,a=c._getGrid(),b;if(!a){return}b=a.getFilterLocal();if(!b){c._filterServer()}else{c._filterLocal()}},initExtraParams:function(){var d=this,b=d._getGrid();if(!b){return}var a=b.getStore(),e=a.getProxy().extraParams,c=d._getFilters()||[];if(!e){return}if(b.otherfilter&&!b.supGrid){c=c.concat(b.otherfilter)}if(b.getFilterStatus()==true&&!b.getFilterLocal()){e.queryCondition=Ext.encode(c)}else{if(!Ext.isEmpty(b.otherfilter)){e.queryCondition=Ext.encode(b.otherfilter)}else{delete e.queryCondition}}},_getFilters:function(){var e=this,b=e._getGrid();if(!b){return}var a=b.getColumnManager().columns,d=[],c=b.getFilterLocal();if(!b.isFilter){return[]}Ext.each(a,function(h){var j=h.bellefilterObj,g={},k;if(j&&j.inputEl&&j.inputEl.dom&&!j.hidden){if(j.config.xtype=="combo"||j.config.xtype=="combobox"||j.config.xtype=="extcombox"){if(j.filterKey==="text"){k=j.getRawValue()}else{k=j.getValue()}}else{k=j.getRawValue()}if(Ext.isEmpty(k)){return true}var i,f;if(typeof(k)==="string"){if(k.trim().length===19){i="Y-m-d H:i:s"}else{i="Y-m-d"}f=Ext.Date.parse(k.trim(),i)}if(f){g={value:Ext.Date.format(f,"Y-m-d"),operator:"13",property:c?j.property:j.propertyName};d.push(g);f.setDate(f.getDate()+1);g={value:Ext.Date.format(f,"Y-m-d"),operator:"12",property:c?j.property:j.propertyName};d.push(g)}else{g={value:k,operator:j.operator,property:c?j.property:j.propertyName};d.push(g)}}});return d},_filterLocal:function(){var d=this,c=d._getGrid();if(!c){return}var a=c.getStore(),b=d._getFilters();if(!a.oddData){return}var e=[];e=a.oddData.filter(function(g){var f=true,h;Ext.each(b,function(i){var k=g.data||g;var j=k[i.property];if(Ext.isEmpty(j)){j=""}if(Ext.isEmpty(i.value)){i.value=""}h=typeof(j);if(Ext.isNumber(j)||Ext.isNumeric(j)){h="number";j=parseFloat(j)}switch(i.operator){case"15":if(h!="string"){f=j.toString().toLowerCase().indexOf(i.value.toLowerCase())>=0}else{f=j.toLowerCase().indexOf(i.value.toLowerCase())>=0}break;case"19":if(h!="string"){j=j.toString().toLowerCase()}else{j=j.toLowerCase()}if(i.value.length<=j.length){if(j.substring(0,i.value.length)==i.value.toLowerCase()){f=true}else{f=false}}else{f=false}break;case"20":if(h!="string"){j=j.toString().toLowerCase()}else{j=j.toLowerCase()}if(i.value.length<=j.length){if(j.substring(j.length-i.value.length,j.length)==i.value.toLowerCase()){f=true}else{f=false}}else{f=false}break;case"10":f=j==i.value;break;case"12":switch(h){case"number":f=j<parseFloat(i.value);break;case"string":f=d._comparisonDateValue(j,i.value);break;default:f=false;break}break;case"11":switch(h){case"number":f=j>parseFloat(i.value);break;case"string":f=!d._comparisonDateValue(j,i.value);break;default:f=false;break}break}if(!f){return false}});return f});d.initExtraParams();a.loadData(e)},_comparisonDateValue:function(b,a){var d=Ext.Date.parse(b,"Y-m-d H:i:s")||Ext.Date.parse(b,"Y-m-d");var c=Ext.Date.parse(a,"Y-m-d H:i:s")||Ext.Date.parse(a,"Y-m-d");if(d&&c){return d.getTime()<c.getTime()}else{return false}},_filterServer:function(){var b=this,a=b._getGrid();if(!a){return}store=a.getStore();if(!a.isFilter){return}b.initExtraParams();store.loadPage(1)},initGridMethods:function(b){var c=this,a=b.getColumnManager().columns;b.getFilterStatus=function(){return b.isFilter};b.setFilterStatus=function(d){var e=b.getStore();if(d){b.isFilter=true;b.removeCls("grid-filter-hide")}else{b.isFilter=false;b.addCls("grid-filter-hide");c.clearFilterValue()}b.fireEvent("onFilterStatusChange",b.isLocal,b.isFilter,b)};b.getFilterLocal=function(){return b.isLocal};b.setFilterLocal=function(d){b.setFilterStatus(true);b.isLocal=d;c.initExtraParams();b.fireEvent("onFilterLocalChange",c.isLocal,c.isFilter,c);if(d){Ext.each(a,function(e){if(e.bellefilterObj){e.bellefilterObj.show()}})}else{Ext.each(a,function(e){if(e.bellefilterObj&&e.bellefilterObj.isOpen==false){e.bellefilterObj.hide()}})}};b.setOtherFilters=function(d){b.otherfilter=d;c.initExtraParams()};b.getFilters=function(){return c._getFilters()};b.initExtraParams=function(){c.initExtraParams()}},clearFilterValue:function(){var d=this,c=d._getGrid();if(!c){return}var b=c.columns,a=c.getStore();Ext.each(b,function(f){var g=f.bellefilterObj,e={},h;if(g&&g.inputEl&&g.inputEl.dom&&!g.hidden){g.setValue("")}});if(c&&c.getFilterLocal()&&!Ext.isEmpty(a.oddData)){a.loadData(a.oddData)}if(c&&!c.getFilterLocal()){d.initExtraParams();a.load()}}});Ext.override(Ext.grid.feature.Summary,{renderSummaryRow:function(c,d,f){var b=c.view,g=b.findFeature("summary"),a;if(c.view.grid.store.getCount()<=c.viewStartIndex+c.rows.length){if(g.showSummaryRow){a=g.summaryRecord;d.push('<table class="'+Ext.baseCSSPrefix+"table-plain "+g.summaryItemCls+'">');g.outputSummaryRecord((a&&a.isModel)?a:g.createSummaryRecord(b),c,d,f);d.push("</table>")}}else{var e=Ext.query(".x-table-plain.x-grid-item-summary");if(e){Ext.each(e,function(h){h.hidden=true})}return}}});Ext.override(Ext.grid.header.Container,{getColumnMenu:function(g){var c=[],b=0,f,a=g.query(">gridcolumn[hideable]"),h=a.length,e;for(;b<h;b++){f=a[b];var d=false;if(f.config&&f.config.editor&&f.config.editor.allowBlank==false){d=true}if(!d){e=new Ext.menu.CheckItem({text:f.menuText||f.text,checked:!f.hidden,hideOnClick:false,headerId:f.id,menu:f.isGroupHeader?this.getColumnMenu(f):undefined,checkHandler:this.onColumnCheckChange,scope:this});c.push(e)}}return c.length?c:null},getMenuItems:function(){var d=this,c=[],b=d.up(),a=d.enableColumnHide?d.getColumnMenu(d):null;if(d.sortable){c=[{itemId:"ascItem",text:d.sortAscText,iconCls:d.menuSortAscCls,handler:d.onSortAscClick,scope:d},{itemId:"descItem",text:d.sortDescText,iconCls:d.menuSortDescCls,handler:d.onSortDescClick,scope:d}]}if(b.canSaveGridLayout&&b.mSizeIdx<0){c.push({itemId:"saveGridLayout",text:"保存布局",glyph:Belle.Icon.btnSave,handler:d.onSaveGridLayout,scope:d});c.push({itemId:"delGridLayout",text:"清除自定义布局",glyph:Belle.Icon.btnDelete,handler:d.onDeleteGridLayout,scope:d})}if(a&&a.length){if(d.sortable){c.push({itemId:"columnItemSeparator",xtype:"menuseparator"})}c.push({itemId:"columnItem",text:d.columnsText,iconCls:d.menuColsIcon,menu:a,hideOnClick:false})}return c},onDeleteGridLayout:function(){var f=this,g={},d=f.up(),e,a,c=[],b;Belle.confirm("是否确认清除当前网格的自定义布局？",function(h){if(h!="yes"){return}a=d.up();while(a&&!a.moduleUrl){a=a.up()}b=window.main?window.main.userInfo.userCode:Belle.getUrlParam("u");if(a){e=a.xtype}if(!b){Belle.alert("未获取到账号数据");return}if(!e){Belle.alert("未获取到模块信息");return}g.gridId=d.reference;g.resCode=e;a.mask("正在删除布局信息...");d.up("basepage").controller.callServer({url:"/uc_layout_v1/deleteLayout.json?",params:g,success:function(i,j){var k=Ext.decode(i.responseText);a.unmask();if(k.flag&&k.flag.retCode=="0"){Belle.alert("删除成功！")}else{Belle.alert("删除失败！")}},failure:function(i,j){Belle.alert("服务器异常！请联系管理员")}})})},onSaveGridLayout:function(){var f=this,g={},d=f.up(),e,a,c=[],b;Belle.confirm("是否确认保存当前网格布局？",function(h){if(h!="yes"){return}a=d.up();while(a&&!a.moduleUrl){a=a.up()}b=window.main?window.main.userInfo.userCode:Belle.getUrlParam("u");if(a){e=a.xtype}Ext.each(d.headerCt.columnManager.getColumns(),function(j){if(j.isCheckerHd){return true}var i={width:j.width,hidden:j.hidden?true:false};if(j.dataIndex){i.dataIndex=j.dataIndex}if(j.text&&j.text!="&#160;"){i.text=j.text}c.push(i)});if(!b){Belle.alert("未获取到账号数据");return}if(!e){Belle.alert("未获取到模块信息");return}if(c.length<=0){return}g.gridId=d.reference;g.layoutJson=Ext.encode(c);g.resCode=e;a.mask("正在保存布局信息...");d.up("basepage").controller.callServer({url:"/uc_layout_v1/saveLayout.json",params:g,success:function(i,j){var k=Ext.decode(i.responseText);a.unmask();if(k.flag&&k.flag.retCode=="0"){Belle.alert("保存布局信息成功！")}else{Belle.alert("保存布局信息失败！")}},failure:function(i,j){a.unmask();Belle.alert("服务器异常！请联系管理员")}})})}});Ext.override(Ext.view.Table,{cellTpl:["{%",'var tipValue="";',"if(values.column.dataIndex&& values.column.openTip!=false) tipValue=values.column.tipText||Ext.util.Format.htmlEncode(values.value); ","%}",'<td data-qtip="{[tipValue]}" class="{tdCls}" {tdAttr} {[Ext.aria ? "id=\\"" + Ext.id() + "\\"" : ""]} style="width:{column.cellWidth}px;<tpl if="tdStyle">{tdStyle}</tpl>" tabindex="-1" {ariaCellAttr} data-columnid="{[values.column.getItemId()]}">','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner {innerCls}" ','style="text-align:{align};<tpl if="style">{style}</tpl>" {ariaCellInnerAttr}>{value}</div>',"</td>",{priority:0}]});Ext.override(Ext.data.Connection,{timeout:120000});Ext.override(Ext.window.Window,{constrainHeader:true});Ext.override(Ext.form.Panel,{initComponent:function(){var a=this;if(a.frame){a.border=false}a.initFieldAncestor();a.callParent();a.relayEvents(a.form,["beforeaction","actionfailed","actioncomplete","validitychange","dirtychange"]);if(a.pollForChanges){a.startPolling(a.pollInterval||500)}if(!a.plugins||!a.plugins.join){a.plugins=[]}}});Ext.override(Ext.app.bind.BaseBinding,{privates:{notify:function(d){var c=this,a=c.options||c.defaultOptions,b=c.lastValue;if(!c.calls||c.deep||b!==d||b==0||Ext.isArray(d)){++c.calls;c.lastValue=d;if(c.lateBound){c.scope[c.callback](d,b,c)}else{c.callback.call(c.scope,d,b,c)}if(a.single){c.destroy()}}}}});
Ext.define("Belle_Common.ux.MaterialField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.materialfield",canQueryCondition:true,constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}a.canQueryCondition=b.canQueryCondition;if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{header:"产品ID",dataIndex:"materialNo"},{header:"产品编码",dataIndex:"materialCode"},{header:"国际条码",dataIndex:"barcodeEan"},{header:"产品名称",dataIndex:"materialName",belleFilter:{xtype:"sumfield",groupField:"materialName"}},{header:"产品小类",dataIndex:"categoryName"},{header:"款号",dataIndex:"styleNo"}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"materialNo",fieldLabel:"产品ID",canQueryCondition:true},{name:"materialCode",fieldLabel:"产品编码",canQueryCondition:true},{name:"barcodeEan",fieldLabel:"国际条码",canQueryCondition:true},{name:"materialName",fieldLabel:"产品名称",canQueryCondition:true},{name:"categoryName",fieldLabel:"产品小类"},{name:"styleNo",fieldLabel:"款号",canQueryCondition:true}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_material/listMSizeVo.json?selectVoName=SelectListByVoBasMaterialCategoryModel&mapperClassType=BasMaterialMapper&mType=2"}if(!Ext.isEmpty(a.brandNo)){if(Ext.isEmpty(a.filters)){a.filters=[]}a.filters.push({property:"brandNo",value:a.brandNo})}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},checkFun:function(c,d){var b=this,a;if(Ext.isString(c)){a=c}else{a=c[0].get("materialNo")}b._vailMateril(b.billNo,a,function(e){var f=e<=0;if(f===false){Belle.alert("产品不能重复添加")}d(f)})},_vailMateril:function(b,a,c){Ext.Ajax.request({method:"GET",url:Belle.sdsPath+"bl_co_dtl/findCount.json",params:{billNo:b,materialNo:a},success:function(d){var e=Ext.decode(d.responseText);if(e.count){c(e.count)}else{c(-1)}},failure:function(d,e){c(-1)}})},winTitle:"产品选择器"});
Ext.define("Belle_Common.ux.MaterialListField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.materiallistfield",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}a.canQueryCondition=false;if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{dataIndex:"materialNo",text:"产品ID",flex:0.5},{dataIndex:"materialCode",text:"产品编码",flex:0.5},{dataIndex:"materialName",text:"产品名称",flex:0.5}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"materialNo",fieldLabel:"产品ID",canQueryCondition:true},{name:"materialCode",fieldLabel:"产品编码",canQueryCondition:true},{name:"materialName",fieldLabel:"产品名称",canQueryCondition:true}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_material/list.json"}if(!Ext.isEmpty(a.brandNo)){if(Ext.isEmpty(a.filters)){a.filters=[]}}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"产品选择器"});
Ext.define("Belle_Common.ux.MaterialSelectionWin",{extend:"Belle_Common.ux.SearchWin",alias:"widget.materialselectionwin",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{header:"产品ID",dataIndex:"materialNo"},{header:"产品编码",dataIndex:"materialCode"},{header:"国际条码",dataIndex:"barcodeEan"},{header:"产品名称",dataIndex:"materialName"},{header:"产品小类",dataIndex:"categoryName"},{header:"款号",dataIndex:"styleNo"}]}if(a.searchItems==undefined){a.searchItems=[{name:"materialNo",fieldLabel:"产品ID"},{name:"materialCode",fieldLabel:"产品编码"},{name:"barcodeEan",fieldLabel:"国际条码"},{name:"materialName",fieldLabel:"产品名称"},{name:"categoryName",fieldLabel:"产品小类"},{name:"styleNo",fieldLabel:"款号"}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_material/listMSizeVo.json?selectVoName=SelectListByVoBasMaterialCategoryModel&mapperClassType=BasMaterialMapper&mType=2"}if(!Ext.isEmpty(a.brandNo)){if(Ext.isEmpty(a.filters)){a.filters=[]}a.filters.push({property:"brandNo",value:a.brandNo,operator:"10"})}if(!Ext.isEmpty(a.otherGridColumns)){a.gridColumns=a.gridColumns.concat(a.otherGridColumns)}if(!Ext.isEmpty(a.otherSearchItems)){a.searchItems=a.searchItems.concat(a.otherSearchItems)}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"产品选择器"});
Ext.define("Ext.form.field.SummarySearchField",{extend:"Ext.form.field.ComboBox",alias:["widget.summarysearchfield","widget.sumfield"],triggers:{clear:{cls:"x-form-clear-trigger",handler:"onClearTriggerClick",hidden:true,scope:"this"}},onClearTriggerClick:function(){var a=this;a.setValue("");a.getTrigger("clear").hide()},onTriggerClick:function(){var a=this;a.duringTriggerClick=true;if(!a.readOnly&&!a.disabled){if(a.isExpanded){a.collapse()}else{a.onFocus({});if(a.triggerAction==="all"){a.doQuery(a.allQuery,true)}else{if(a.triggerAction==="last"){a.doQuery(a.lastQuery,true)}else{a.doQuery(a.getRawValue(),false,true)}}}}delete a.duringTriggerClick},groupField:"",displayField:"text",valueField:"value",store:{fields:["text","value","count"]},initComponent:function(){var a=this;a.callParent(arguments);a.on("expand",function(){a._bindData()})},_bindData:function(){var d=this,e=[],a={},b=d.grid,c=b.store;if(!d.grid){return}if(!d.groupField){return}Ext.each(c.getData().items,function(f){if(!a[f.get(d.groupField)]){a[f.get(d.groupField)]={text:f.get(d.groupField),count:1,value:f.get(d.groupField)}}else{a[f.get(d.groupField)].count+=1}});for(item in a){e.push(a[item])}a=[];d.store.oddData=e;d.store.loadData(e)}});
Ext.define("Belle_Common.ux.WorkShopField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.workshopfield",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{dataIndex:"workshopNo",text:"车间编号",flex:0.5},{dataIndex:"workshopName",text:"车间名称",flex:0.5}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"workshopNo",fieldLabel:"车间编号"},{name:"workshopName",fieldLabel:"车间名称"}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_workshop/list.json"}if(!Ext.isEmpty(a.otherGridColumns)){a.gridColumns=a.gridColumns.concat(a.otherGridColumns)}if(!Ext.isEmpty(a.otherSearchItems)){a.searchItems=a.searchItems.concat(a.otherSearchItems)}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"车间选择器"});
Ext.define("Belle_Common.ux.WorkshopSuppliersField",{extend:"Belle_Common.ux.SearchHelpField",alias:"widget.workshopsuppliersfield",constructor:function(a){var b=this;if(Ext.isEmpty(a)){a={}}if(Ext.isEmpty(a.gridColumns)){a.gridColumns=[{dataIndex:"supplierNo",text:"供应商编号",flex:0.5},{dataIndex:"supplierName",text:"供应商名称",flex:0.5}]}if(Ext.isEmpty(a.searchItems)){a.searchItems=[{name:"supplierNo",fieldLabel:"供应商编号"},{name:"supplierName",fieldLabel:"供应商名称"}]}if(Ext.isEmpty(a.url)){a.url=Belle.mdmPath+"bas_supplier/list.json"}if(!Ext.isEmpty(a.otherGridColumns)){a.gridColumns=a.gridColumns.concat(a.otherGridColumns)}if(!Ext.isEmpty(a.otherSearchItems)){a.searchItems=a.searchItems.concat(a.otherSearchItems)}Ext.apply(b,a);b.callParent(arguments)},initComponent:function(){var a=this;a.callParent(arguments)},winTitle:"供应商选择器"});
Ext.define("Belle_Common.ux.extGridComoboxColumn",{extend:"Ext.grid.column.Column",alias:"widget.bllookupedit",estore:null,gstore:null,readOnly:false,editable:true,autoLoad:true,initComponent:function(){var j=this;j.type="0";if(j.readOnly){if(j.gstore==null){var a=null;if(j.valuemember==null){j.valuemember="num";j.displaymember="name";var h=h||[];var n=j.displayvalue.split(":");for(var f=0;f<n.length;f++){var m=n[f].split("=");var d={};var l=m[0];var k=m[1];d.num=l;d.name=k;h.push(d)}a=Ext.create("Ext.data.Store",{fields:[j.valuemember,j.displaymember],data:h});j.type="1"}else{a=Ext.create("Belle_Common.store.Base",{fields:[j.valuemember,j.displaymember,j.autoLoad],proxy:{url:Belle.setUrlModuleInfo(j.up().grid,j.displayvalue)}})}a.reload();j.store=a}else{j.store=j.gstore}}else{var b=j.editor&&j.editor.allowBlank;var c=(j.editor&&j.editor.multiSelect)||j.multiSelect||false;if(j.valuemember){j.displayvalue=Belle.setUrlModuleInfo(j.up().grid,j.displayvalue)}j.editor=Ext.create("Belle_Common.ux.ComboCustom",{displaymember:j.displaymember,valuemember:j.valuemember,displayvalue:j.displayvalue,store:j.estore,editable:this.editable,multiSelect:c});if(b===false){j.editor.allowBlank=false}if(j.valuemember==null){j.valuemember="num";j.displaymember="name";j.type="1"}if(j.gstore==null){j.store=j.editor.store}else{j.store=j.gstore}}try{j.callParent()}catch(g){Belle.alert(g)}},defaultRenderer:function(e){var d=this,b=0;if(e==null){return}if(e.toString().indexOf(",")==-1&&!e.join){if(d.type=="0"){b=d.store.findExact(d.valuemember,e)}else{b=d.store.findExact(d.valuemember,e.toString())}return b>-1?d.store.getAt(b).data[d.displaymember]:e}else{var f=e.join?e:e.split(","),a=[];for(var c=0;c<f.length;c++){b=d.store.findExact(d.valuemember,f[c]);a.push(b>-1?d.store.getAt(b).data[d.displaymember]:f[c])}return a.join(",")}}});
Ext.define("Belle_Common.ux.extGridDateColumn",{extend:"Ext.grid.column.Date",alias:"widget.blgriddate",format:"Y-m-d",readOnly:false,editable:false,initComponent:function(){if(!this.readOnly){var a=this.editor&&this.editor.allowBlank;this.editor=Ext.create("Belle_Common.ux.DateTimeField",{format:this.format,readOnly:this.readOnly,value:this.value,contype:"date",editable:this.editable});if(a===false){this.editor.allowBlank=false}if(this.minValue){this.editor.minValue=this.minValue}if(this.maxValue){this.editor.maxValue=this.maxValue}}this.callParent()}});
Ext.define("Belle_Common.ux.extGridDateTimeColumn",{extend:"Ext.grid.column.Date",alias:"widget.blgriddatetime",format:"Y-m-d H:i:s",readOnly:false,initComponent:function(){if(!this.readOnly){var a=this.editor&&this.editor.allowBlank;this.editor=Ext.create("Belle_Common.ux.DateTimeField",{format:this.format,readOnly:this.readOnly,value:this.value,contype:"datetime"});if(a===false){this.editor.allowBlank=false}}this.callParent()}});
Ext.define("Belle_Common.ux.gridComboUseFlag",{extend:"Belle_Common.ux.extGridComoboxColumn",alias:"widget.gridcombouseflag",displayvalue:"1=启用:0=禁用",editable:false,initComponent:function(){this.callParent()}});
Ext.define("Belle_Common.ux.gridComboYesNo",{extend:"Belle_Common.ux.extGridComoboxColumn",alias:"widget.gridcomboyesno",displayvalue:"1=是:0=否",editable:false,initComponent:function(){this.callParent()}});
Ext.define("Belle_Common.ux.Log",{extend:"Ext.panel.Panel",alias:"widget.log",constructor:function(b){var e=this;if(!b.masterGrid){return}var h=Belle.clone(b.masterGrid.vcolumn),d=b.masterGrid.store.model.getFields(),g=["logTime","logUser","logAttribute"],f=[{header:"操作类型",dataIndex:"logAttribute",renderer:function(j){var i="";switch(j){case"a":i="新增";break;case"u":i="更新";break;case"d":i="删除";break}return i}},{header:"记录人",dataIndex:"logUser"},{header:"记录时间",dataIndex:"logTime"},];Ext.each(h,function(i){if(i.editor){delete i.editor}if(i.renderer==="renderUseFlag"){i.renderer=e.renderUseFlag}if(i.renderer==="renderYesNo"){i.renderer=e.renderYesNo}});h=h.concat(f);d=d.concat(g);b.gridColumns=h;b.gridFields=d;b.pageSize=b.parentView.pageSize;var a=b.parentView.gridLoadUrl,c;if(a.indexOf("?")>=0){c="&moduleEntity="}else{c="?moduleEntity="}b.gridLoadUrl=a+c+b.parentView.gridModelText;e.callParent(arguments)},initComponent:function(){var d=this;d.columnWidth=1;d.layout="border";var c=d.createToolbar(),b=d.createSearchForm(),a=d.createGrid();if(!d.items){d.items=[]}if(c){d.items.push(c)}if(b&&b.items&&b.items.length>0){d.items.push(b)}if(a){d.items.push(a)}d.callParent(arguments)},initEvents:function(){var a=this;a.toolbar.down("button[itemId='closeLog']").on("click",function(b){a.up().close()});a.toolbar.down("button[itemId='btnLogSearch']").on("click",function(b){a.onSearch(b)})},toolbarView:{xtype:"toolbar",reference:"logToolbar",region:"north",items:[{text:"查询",itemId:"btnLogSearch",reference:"btnLogSearch",glyph:Belle.Icon.btnSearch},{text:"返回",itemId:"closeLog",glyph:Belle.Icon.btnUndo}]},gridView:{xtype:"grid",reference:"logGrid",region:"center",columnLines:true,columns:[],bbar:{xtype:"pagingtoolbar",displayInfo:true},viewConfig:{enableTextSelection:true},selModel:{},features:[]},searchFormView:{columns:4,xtype:"form",region:"north",reference:"searchLog",collapsible:true,title:"查询面板",layout:{type:"table"},header:{height:20,padding:0},defaults:{labelAlign:"right",width:"100%",labelWidth:80,style:"margion-top:5px; margion-right:5px;:"},defaultType:"textfield",bodyPadding:3,autoScroll:true,items:[]},createToolbar:function(){var a=this;if(!a.toolbar){a.toolbar=Ext.create("Ext.toolbar.Toolbar",a.toolbarView)}return a.toolbar},createSearchForm:function(){var a=this,b=a.parentView.searchItems;if(!a.searchForm&&b){a.searchFormView.layout.columns=a.parentView.searchColumn;if(b.length>3){a.searchFormView.layout.type="table"}else{if(b.length>0){a.searchFormView.layout.type="column";Ext.each(b,function(c){c.columnWidth=c.columnWidth||"0.25"})}}a.searchFormView.items=b;a.searchForm=Ext.create("Ext.form.Panel",a.searchFormView)}return a.searchForm},createGrid:function(){var b=this;if(!b.grid){var a=Ext.create("Ext.data.Store",{autoLoad:true,fields:b.gridFields,pageSize:b.pageSize,proxy:{url:b.gridLoadUrl,type:"ajax",reader:{type:"json",rootProperty:"list",totalProperty:"totalCount"},pageParam:"pageNum",limitParam:"pageSize",startParam:""}});b.gridView.store=a;b.gridView.columns=b.gridColumns;b.gridView.bbar.store=a;b.gridView.bbar.plugins=Ext.create("Ext.ux.ComboPageSize",{defaultSize:b.pageSize});b.grid=Ext.create("Ext.grid.Panel",b.gridView)}return b.grid},onSearch:function(c){var f=this,a=f.grid,b=f.searchForm,g=a.getStore(),e=g.getProxy().extraParams||{},h=b.getValues();c.setDisabled(true);for(var i in h){var d=h[i];if(!Ext.isEmpty(d)){e[i]=h[i]}else{delete e[i]}}g.getProxy().extraParams=e;g.loadPage(1,{callback:function(k,j,l){c.setDisabled(false)}})}});
